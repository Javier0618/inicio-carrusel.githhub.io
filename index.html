<!DOCTYPE html >
  <html lang="es-MX">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StreamFusion - Streaming Entertainment</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="preconnect" href="https://api.themoviedb.org">
<link rel="preconnect" href="https://image.tmdb.org">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://www.gstatic.com">
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style">
<link rel="preload" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhqC8k7QO6KNqYZXNkGt-F0knO2XMq4VDjl0_sM6sbPa3FEt4_PyIs3oiThacqu1-jG7-8v7a14KGcjn8_YBEI33yLlrmcobGnt-TT9_TNMie71bwN_d9fSX6WTHSv4gtZgtN8CRyTIey5fRLOEFQmoYQ-bZImSBQXfvL6vMlJ55WORvg/s1600/StreamFusion.png" as="image">
<script src="non-critical-script.js" defer></script>
<style>
/* Variables and global configuration */
#navbar-iframe{
display: none;
}
:root {
  --primary-color: #0A1128;
  --secondary-color: #00E8FC;
  --accent-color: #7B42F6;
  --dark-bg: #0F0F0F;
  --dark-bg-lighter: #1A1A1A;
  --card-bg: #252525;
  --text-color: #FFFFFF;
  --text-secondary: #B3B3B3;
  --border-color: #333333;
  --transition-speed: 0.3s;
  --border-radius: 8px;
  --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  --error-color: #ff4d4d;
  --success-color: #4CAF50;
}

body #header {
  margin-top: 0 !important;
}
/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Base styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: var(--dark-bg);
  color: var(--text-color);
  line-height: 1;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

img {
  pointer-events: none;
  -webkit-user-drag: none;
  user-drag: none;
}
a {
  text-decoration: none;
  color: inherit;
}

button {
  cursor: pointer;
  font-family: inherit;
  border: none;
  background: none;
  outline: none;
}

img {
  max-width: 100%;
  height: auto;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--dark-bg);
}

::-webkit-scrollbar-thumb {
  background: #555;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #777;
}

/* Login and Registration Styles */
.auth-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--dark-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://assets.nflxext.com/ffe/siteui/vlv3/c31c3123-3df7-4359-8b8c-475bd2d9925d/15feb590-3d73-45e9-9e4a-2eb334c83921/MX-es-20231225-popsignuptwoweeks-perspective_alpha_website_large.jpg');
  background-size: cover;
  background-position: center;
}

.auth-form-container {
  background-color: rgba(0, 0, 0, 0.75);
  border-radius: var(--border-radius);
  width: 100%;
  max-width: 450px;
  padding: 60px 68px 40px;
  margin: 0 auto;
  box-shadow: var(--box-shadow);
  animation: fadeIn 0.5s, slideUp 0.5s;
}

.auth-logo {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 30px;
}

.auth-logo img {
  height: 50px;
  width: auto;
}

.auth-logo h1 {
  font-size: 2rem;
  font-weight: 800;
  background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-left: 10px;
}

.auth-title {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 28px;
  text-align: center;
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-group {
  position: relative;
}

.form-input {
  width: 100%;
  padding: 16px 20px;
  border-radius: 4px;
  background-color: #333;
  border: none;
  color: white;
  font-size: 1rem;
  outline: none;
  transition: background-color 0.3s;
}

.form-input:focus {
  background-color: #454545;
}

.form-input::placeholder {
  color: #8c8c8c;
}

.auth-btn {
  width: 100%;
  padding: 16px;
  border-radius: 4px;
  background-color: var(--secondary-color);
  color: var(--primary-color);
  font-size: 1rem;
  font-weight: 700;
  margin-top: 24px;
  transition: background-color 0.3s;
}

.auth-btn:hover {
  background-color: #00c5d6;
}

.auth-switch {
  margin-top: 16px;
  color: var(--text-secondary);
  text-align: center;
}

.auth-switch a {
  color: var(--text-color);
  margin-left: 5px;
  cursor: pointer;
}

.auth-switch a:hover {
  text-decoration: underline;
}

.auth-error {
  color: var(--error-color);
  font-size: 0.9rem;
  margin-top: 5px;
  animation: fadeIn 0.3s;
}

.auth-success {
  color: var(--success-color);
  font-size: 0.9rem;
  margin-top: 5px;
  animation: fadeIn 0.3s;
}

/* User Profile Icon */
.user-profile {
  position: relative;
}

.profile-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background-color: var(--accent-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.3s;
  position: relative; /* Asegura que esto est√© configurado para el posicionamiento absoluto del badge */
}

.profile-icon:hover {
  background-color: #6a36d9;
}

/* Notification Badge Styles */
.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background-color: #ff4d4d;
  color: white;
  font-size: 0.7rem;
  font-weight: bold;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.profile-dropdown {
  position: absolute;
  top: 45px;
  right: 0;
  background-color: var(--dark-bg-lighter);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  width: 200px;
  z-index: 1000;
  display: none;
  animation: fadeIn 0.3s;
}

.profile-dropdown.active {
  display: block;
}

.profile-dropdown-item {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background-color 0.3s;
}

.profile-dropdown-item:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

.profile-dropdown-item i {
  width: 20px;
  text-align: center;
  color: var(--secondary-color);
}

/* Admin Panel Styles */
.admin-panel {
  display: none;
  padding: 2rem 0;
  animation: fadeIn 0.5s ease;
}

.admin-panel.active {
  display: block;
}

.admin-tabs {
  display: flex;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 20px;
}

.admin-tab {
  padding: 10px 20px;
  cursor: pointer;
  transition: all 0.3s;
  border-bottom: 2px solid transparent;
}

.admin-tab.active {
  border-bottom: 2px solid var(--secondary-color);
  color: var(--secondary-color);
}

.admin-tab:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.admin-content {
  background-color: var(--dark-bg-lighter);
  border-radius: var(--border-radius);
  padding: 20px;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
}

.admin-table th, .admin-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.admin-table th {
  background-color: rgba(0, 0, 0, 0.2);
  color: var(--secondary-color);
}

.admin-table tr:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.admin-action-btn {
  padding: 6px 12px;
  border-radius: 4px;
  margin-right: 5px;
  font-size: 0.8rem;
}

.admin-action-btn.edit {
  background-color: var(--secondary-color);
  color: var(--primary-color);
}

.admin-action-btn.delete {
  background-color: var(--error-color);
  color: white;
}

.admin-action-btn.message {
  background-color: var(--accent-color);
  color: white;
}

.admin-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
  max-width: 600px;
  margin: 0 auto;
}

.admin-form textarea {
  width: 100%;
  padding: 12px;
  border-radius: 4px;
  background-color: #333;
  border: none;
  color: white;
  font-size: 1rem;
  min-height: 150px;
  resize: vertical;
}

.admin-form select {
  width: 100%;
  padding: 12px;
  border-radius: 4px;
  background-color: #333;
  border: none;
  color: white;
  font-size: 1rem;
}

.admin-form option {
  background-color: #333;
}

.admin-form button {
  padding: 12px;
  border-radius: 4px;
  background-color: var(--secondary-color);
  color: var(--primary-color);
  font-weight: bold;
  margin-top: 10px;
}

/* User Profile Page Styles */
.user-profile-page {
  display: none;
  padding: 0rem 0;
  animation: fadeIn 0.5s ease;
}

.user-profile-page.active {
  display: block;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 30px;
}

.profile-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background-color: var(--accent-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  font-weight: bold;
}

.profile-info h2 {
  font-size: 2rem;
  margin-bottom: 5px;
}

.profile-info p {
  color: var(--text-secondary);
}

.profile-tabs {
  display: flex;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 20px;
}

.profile-tab {
  padding: 10px 20px;
  cursor: pointer;
  transition: all 0.3s;
  border-bottom: 2px solid transparent;
}

.profile-tab.active {
  border-bottom: 2px solid var(--secondary-color);
  color: var(--secondary-color);
}

.profile-tab:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.profile-content {
  background-color: var(--dark-bg-lighter);
  border-radius: var(--border-radius);
  padding: 20px;
}

.profile-section {
  display: none;
}

.profile-section.active {
  display: block;
}

.profile-detail {
  margin-bottom: 15px;
}

.profile-detail label {
  display: block;
  color: var(--secondary-color);
  margin-bottom: 5px;
  font-weight: 500;
}

.profile-detail p {
  padding: 10px;
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

.messages-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.message-item {
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: var(--border-radius);
  padding: 15px;
  border-left: 3px solid var(--secondary-color);
  position: relative;
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.message-sender {
  font-weight: bold;
  color: var(--secondary-color);
}

.message-date {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.message-content {
  line-height: 1.5;
}

.message-actions {
  position: absolute;
  right: 15px;
  display: flex;
  gap: 10px;
}

.message-delete-btn {
  background-color: var(--error-color);
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  transition: all 0.3s;
}

.message-delete-btn:hover {
  transform: scale(1.1);
  background-color: #ff3333;
}

.no-messages {
  text-align: center;
  padding: 20px;
  color: var(--text-secondary);
}

.user-message-form {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border-color);
}

.user-message-form h3 {
  margin-bottom: 15px;
  color: var(--secondary-color);
}

.user-message-form textarea {
  width: 100%;
  padding: 12px;
  border-radius: 4px;
  background-color: #333;
  border: none;
  color: white;
  font-size: 1rem;
  min-height: 100px;
  resize: vertical;
  margin-bottom: 15px;
}

.user-message-form button {
  padding: 10px 20px;
  border-radius: 4px;
  background-color: var(--secondary-color);
  color: var(--primary-color);
  font-weight: bold;
  transition: all 0.3s;
}

.user-message-form button:hover {
  background-color: #00c5d6;
}

.user-message-form button:disabled {
  background-color: #555;
  color: #999;
  cursor: not-allowed;
}

.message-limit-info {
  margin-top: 10px;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.message-limit-warning {
  color: var(--error-color);
  font-weight: bold;
}

/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  z-index: 3000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s;
}

.modal-container {
  background-color: var(--dark-bg-lighter);
  border-radius: var(--border-radius);
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--box-shadow);
  animation: fadeIn 0.3s, slideUp 0.3s;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-bottom: 1px solid var(--border-color);
}

.modal-title {
  font-size: 1.2rem;
  font-weight: bold;
}

.modal-close {
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--text-secondary);
  transition: color 0.3s;
}

.modal-close:hover {
  color: var(--text-color);
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 15px 20px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.modal-btn {
  padding: 8px 16px;
  border-radius: 4px;
  font-weight: 500;
}

.modal-btn-primary {
  background-color: var(--secondary-color);
  color: var(--primary-color);
}

.modal-btn-secondary {
  background-color: rgba(255, 255, 255, 0.1);
  color: var(--text-color);
}

.modal-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

/* Header and navigation */
header {
  background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 50%, transparent 100%);
  padding: 1rem 4%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  transition: background-color var(--transition-speed);
}

header.scrolled {
  background-color: var(--dark-bg);
}

.logo-container {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.logo-img {
  height: 35px;
  width: auto;
}

.logo-text {
  font-size: 1.5rem;
  font-weight: 800;
  background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.nav-links {
  display: flex;
  gap: 1.5rem;
}

.nav-link {
  font-size: 0.9rem;
  font-weight: 500;
  transition: color var(--transition-speed);
  position: relative;
}

.nav-link:hover, .nav-link.active {
  color: var(--secondary-color);
}

.nav-link.active::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: var(--secondary-color);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

.search-container {
  position: relative;
}

.search-input {
  background-color: rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 20px;
  padding: 0.5rem 2.5rem 0.5rem 1rem;
  color: var(--text-color);
  width: 0;
  opacity: 0;
  transition: width var(--transition-speed), opacity var(--transition-speed);
}

.search-input.active {
  width: 200px;
  opacity: 1;
}

.search-btn {
  color: var(--text-color);
  font-size: 1.2rem;
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
}

.menu-toggle {
  display: block;
  font-size: 1.5rem;
  color: var(--text-color);
}

/* Hero section */
.hero {
  position: relative;
  height: 60vh;
  overflow: hidden;
}

.hero-slide {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  opacity: 0;
  transition: opacity 1s;
  z-index: 1;
}

.hero-slide.active {
  opacity: 1;
  z-index: 2;
}

.hero-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(to right, rgba(0, 0, 0, 0.8) 40%, transparent 100%);
  display: flex;
  align-items: center;
}

.hero-content {
  max-width: 600px;
  padding: 0 30px;
  margin-top: 60px;
}

.hero-title {
  font-size: 48px;
  font-weight: 700;
  margin-bottom: 10px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.hero-description {
  font-size: 18px;
  margin-bottom: 30px;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.hero-buttons {
  display: flex;
  gap: 15px;
}

.btn {
  padding: 12px 24px;
  border-radius: 4px;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background-color 0.3s, transform 0.3s;
}

.btn:hover {
  transform: translateY(-2px);
}

.btn-primary {
  background-color: var(--primary-color);
  color: var(--text-color);
}

.btn-primary:hover {
  background-color: #00c5d6;
} 

.btn-secondary {
  background-color: rgba(255, 255, 255, 0.2);
  color: var(--text-color);
}

.btn-secondary:hover {
  background-color: rgba(255, 255, 255, 0.3);
}

.hero-nav {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  z-index: 3;
}

.hero-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background-color: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  transition: background-color 0.3s, transform 0.3s;
}

.hero-dot:hover {
  background-color: rgba(255, 255, 255, 0.8);
}

.hero-dot.active {
  background-color: var(--primary-color);
  transform: scale(1.2);
}

/* Content sections */
.main-container {
  padding: 0 2%;
  margin-top: 30px;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  padding-left: 0.5rem;
  border-left: 4px solid var(--secondary-color);
}

/* Content rows */
.content-row {
  margin-bottom: 1rem;
}

.row-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.1rem;
}

.see-all {
  color: var(--secondary-color);
  font-size: 0.9rem;
  font-weight: 500;
  transition: color var(--transition-speed);
}

.see-all:hover {
  color: #00c5d6;
}

.content-slider {
  position: relative;
  overflow: hidden;
  width: 100%;
}

.slider-container {
  display: flex;
  transition: transform 0.5s ease;
  margin: 0 -0.5rem;
  overflow-x: auto;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE and Edge */
}

.slider-container::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Opera */
}

.slider-controls {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.slider-arrow {
  width: 40px;
  height: 40px;
  background-color: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  pointer-events: auto;
  opacity: 0;
  transition: opacity var(--transition-speed), background-color var(--transition-speed);
}

.content-slider:hover .slider-arrow {
  opacity: 1;
}

.slider-arrow:hover {
  background-color: rgba(0, 0, 0, 0.8);
}

/* Content cards */
.content-card {
  flex: 0 0 calc(240px - 1rem);
  margin: 0 0.2rem;
  border-radius: var(--border-radius);
  overflow: hidden;
  position: relative;
  transition: transform var(--transition-speed);
  cursor: pointer;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.content-card:hover {
  transform: scale(1.05);
  z-index: 10;
}

.card-poster {
  width: 100%;
  aspect-ratio: 2/3;
  object-fit: cover;
  transition: filter var(--transition-speed);
}

.content-card:hover .card-poster {
  filter: brightness(0.7);
}

  .card-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 50%, transparent 100%);
    transform: translateY(100%);
    transition: transform var(--transition-speed);
  }

  .content-card:hover .card-overlay {
    transform: translateY(0);
  }

  .card-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .card-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .card-rating {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: rgba(0, 0, 0, 0.7);
    color: var(--secondary-color);
    font-weight: 600;
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    z-index: 2;
  }

  .card-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background-color: var(--accent-color);
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    z-index: 2;
  }

  .card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .card-btn {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color var(--transition-speed);
  }

  .card-btn:hover {
    background-color: var(--secondary-color);
    color: var(--primary-color);
  }

/* Streaming services */
.services-container {
  display: flex;
  justify-content: space-between; /* Distribuye el espacio entre los elementos */
  align-items: center;
  background-color: var(--dark-bg-lighter);
  padding: 1rem 2rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
  box-shadow: var(--box-shadow);
  position: relative; /* Added for positioning the back button */
  overflow-x: visible; /* Elimina el scroll horizontal */
}

.service-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  transition: transform var(--transition-speed);
  opacity: 0.7;
  flex: 1; /* Hace que cada elemento ocupe una parte igual del espacio disponible */
  min-width: 0; /* Permite que los elementos se reduzcan m√°s all√° de su contenido */
}

.service-logo {
  height: auto; /* Altura autom√°tica para mantener proporci√≥n */
  width: 100%; /* Ancho al 100% del contenedor padre */
  max-width: 80px; /* Limita el tama√±o m√°ximo */
  min-width: 30px; /* Establece un tama√±o m√≠nimo */
  filter: grayscale(100%);
  transition: filter var(--transition-speed);
}

.service-name {
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--text-secondary);
  display: none;
}

/* Added: Back button for services in mobile view */
.services-back-btn {
  display: none; /* Vuelve a estar oculto por defecto */
  position: absolute;
  top: -30px;
  left: 0;
  background-color: var(--secondary-color);
  color: var(--primary-color);
  padding: 0.2rem 0.2rem;
  border-radius: var(--border-radius);
  font-weight: 600;
  font-size: 0.9rem;
  box-shadow: var(--box-shadow);
  z-index: 10;
  align-items: center;
  gap: 0.5rem;
}

.service-item.active .service-logo {
  filter: none; /* Elimina el efecto de escala de grises */
  transform: scale(1.1); /* Le da un peque√±o efecto de crecimiento */
  transition: filter 0.3s, transform 0.3s;
}

/* Genre sidebar */
.sidebar {
  position: fixed;
  top: 0;
  left: -300px;
  width: 250px;
  height: 100%;
  background-color: var(--dark-bg-lighter);
  z-index: 2000;
  transition: left var(--transition-speed);
  box-shadow: var(--box-shadow);
  overflow-y: auto;
}

.sidebar.active {
  left: 0;
}

.sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 1.5rem;
  border-bottom: 1px solid var(--border-color);
}

.sidebar-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--secondary-color);
}

.close-sidebar {
  font-size: 1.5rem;
  color: var(--text-color);
  transition: color var(--transition-speed);
}

.close-sidebar:hover {
  color: var(--secondary-color);
}

.genre-list {
  list-style: none;
  padding: 0.5rem 0;
}

.genre-item {
  padding: 0.5rem 1.5rem;
  transition: background-color var(--transition-speed);
  display: flex;
  align-items: center;
  gap: 1rem;
}

.genre-item:hover {
  background-color: rgba(0, 232, 252, 0.1);
}

.menu-item {
  padding: 0.5rem 1.5rem;
  transition: background-color var(--transition-speed);
  display: flex;
  align-items: center;
  gap: 1rem;
}

.menu-item:hover {
  background-color: rgba(0, 232, 252, 0.1);
}

.genre-icon {
  font-size: 1.2rem;
  color: var(--secondary-color);
  width: 20px;
  text-align: center;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 1999;
  display: none;
  backdrop-filter: blur(3px);
}

.overlay.active {
  display: block;
}

/* Back to top button */
.back-to-top {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background-color: var(--secondary-color);
  color: var(--primary-color);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  box-shadow: var(--box-shadow);
  opacity: 0;
  transform: translateY(20px);
  transition: opacity var(--transition-speed), transform var(--transition-speed);
  z-index: 99;
}

.back-to-top.visible {
  opacity: 1;
  transform: translateY(0);
}

.back-to-top:hover {
  background-color: #00c5d6;
}

/* Welcome popup */
.welcome-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  padding: 1rem;
}

.popup-content {
  background-color: var(--dark-bg-lighter);
  border-radius: var(--border-radius);
  padding: 2rem;
  max-width: 500px;
  width: 100%;
  box-shadow: var(--box-shadow);
  animation: fadeIn 0.5s, slideUp 0.5s;
  border: 1px solid var(--border-color);
}

.popup-header {
  text-align: center;
  margin-bottom: 1.5rem;
}

.popup-title {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
}

.popup-title span:first-child {
  color: var(--secondary-color);
}

.popup-title span:last-child {
  color: var(--accent-color);
}

.popup-subtitle {
  color: var(--text-secondary);
  font-size: 1rem;
}

.popup-body {
  margin-bottom: 2rem;
}

.popup-section {
  margin-bottom: 1.5rem;
}

.popup-section-title {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  color: var(--secondary-color);
}

.popup-text {
  color: var(--text-secondary);
  font-size: 0.9rem;
  line-height: 1.6;
}

.popup-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.dont-show-again {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-secondary);
}

.checkbox-container {
  position: relative;
  display: inline-block;
  width: 18px;
  height: 18px;
}

.custom-checkbox {
  position: absolute;
  opacity: 0;
  cursor: pointer;
  height: 0;
  width: 0;
}

.checkmark {
  position: absolute;
  top: 0;
  left: 0;
  height: 18px;
  width: 18px;
  background-color: #333;
  border-radius: 3px;
}

.custom-checkbox:checked ~ .checkmark {
  background-color: var(--secondary-color);
}

.checkmark:after {
  content: "";
  position: absolute;
  display: none;
}

.custom-checkbox:checked ~ .checkmark:after {
  display: block;
}

.checkbox-container .checkmark:after {
  left: 6px;
  top: 2px;
  width: 5px;
  height: 10px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.close-popup-btn {
  background-color: var(--secondary-color);
  color: var(--primary-color);
  padding: 0.8rem 1.5rem;
  border-radius: 4px;
  font-weight: 600;
  transition: background-color var(--transition-speed);
}

.close-popup-btn:hover {
  background-color: #00c5d6;
}

/* Loading spinner */
.spinner-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  backdrop-filter: blur(5px);
}

.spinner {
  width: 50px;
  height: 50px;
  border: 3px solid transparent;
  border-top-color: var(--secondary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.spinner:before {
  content: '';
  position: absolute;
  top: 5px;
  left: 5px;
  right: 5px;
  bottom: 5px;
  border: 3px solid transparent;
  border-top-color: var(--accent-color);
  border-radius: 50%;
  animation: spin 2s linear infinite;
}

.spinner:after {
  content: '';
  position: absolute;
  top: 15px;
  left: 15px;
  right: 15px;
  bottom: 15px;
  border: 3px solid transparent;
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1.5s linear infinite;
}

/* Empty state */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0.3rem;
  text-align: center;
  background-color: var(--dark-bg-lighter);
  border-radius: var(--border-radius);
  margin: 2rem 0;
}

.empty-icon {
  font-size: 3rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}

.empty-title {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.empty-text {
  color: var(--text-secondary);
  max-width: 400px; 
  margin-bottom: 1.5rem;
}

/* License status */
.license-status {
  position: fixed;
  bottom: 1rem;
  left: 1rem;
  background-color: #16a34a;
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.license-status i {
  font-size: 0.9rem;
}

/* Full page views */
.page-view {
  display: none;
  padding: 0rem 0;
  animation: fadeIn 0.5s ease;
}

.page-view.active {
  display: block;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 4rem;
  margin-bottom: 0.5rem;
}

.page-title {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--text-color);
}

.back-button {
  background-color: rgba(255, 255, 255, 0.1);
  color: var(--text-color);
  padding: 0.3rem 0.8rem;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: background-color var(--transition-speed);
}

.back-button:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

/* Grid layout for full page views */
.content-grid-view {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 0.5rem;
}

.grid-card {
  border-radius: var(--border-radius);
  overflow: hidden;
  position: relative;
  transition: transform var(--transition-speed);
  cursor: pointer;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  background-color: var(--dark-bg-lighter);
}

.grid-card:hover {
  transform: translateY(-5px);
}

.grid-poster {
  width: 100%;
  aspect-ratio: 2/3;
  object-fit: cover;
}

.grid-info {
  padding: 0.2rem 0.3rem;
}

.grid-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.1rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.grid-meta {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.grid-rating {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background-color: rgba(0, 0, 0, 0.7);
  color: var(--secondary-color);
  font-weight: 600;
  font-size: 0.8rem;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  z-index: 2;
}

.grid-badge {
  position: absolute;
  top: 0.5rem;
  left: 0.5rem;
  background-color: var(--accent-color);
  color: white;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  z-index: 2;
}

.grid-actions {
  position: absolute;
  bottom: 1rem;
  right: 1rem;
  display: flex;
  gap: 0.5rem;
  opacity: 0;
  transition: opacity var(--transition-speed);
}

.grid-card:hover .grid-actions {
  opacity: 1;
}

.grid-btn {
  background-color: var(--secondary-color);
  color: var(--primary-color);
  border-radius: 50%;
  width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform var(--transition-speed);
}

.grid-btn:hover {
  transform: scale(1.1);
}

/* Movie Details Modal Styles */
.movie-details-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 3000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
}

.modal-container {
  position: relative;
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  background-color: var(--dark-bg-lighter);
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--box-shadow);
  animation: fadeIn 0.3s, slideUp 0.3s;
  z-index: 3001;
}

.modal-backdrop {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center top;
  z-index: -1;
}

.modal-backdrop-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(to bottom, rgba(37, 37, 37, 0.7) 0%, var(--dark-bg-lighter) 100%);
}

.modal-content {
  position: relative;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  padding: 2rem;
}

.modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  z-index: 10;
  transition: background-color var(--transition-speed);
}

.modal-close:hover {
  background-color: rgba(0, 0, 0, 0.8);
}

.modal-header {
  display: flex;
  gap: 2rem;
}

.modal-poster {
  flex: 0 0 200px;
}

.modal-poster img {
  width: 100%;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.modal-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.modal-title {
  font-size: 2rem;
  font-weight: 700;
  line-height: 1.2;
}

.modal-meta {
  display: flex;
  gap: 1rem;
  color: var(--text-secondary);
}

.modal-rating {
  color: var(--secondary-color);
}

.modal-genres {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.modal-genre {
  background-color: rgba(255, 255, 255, 0.1);
  padding: 0.3rem 0.8rem;
  border-radius: 20px;
  font-size: 0.8rem;
}

.modal-overview {
  line-height: 1.2;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

.modal-details {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  margin-bottom: 1.5rem;
}

.modal-detail {
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.detail-label {
  font-weight: 600;
  color: var(--secondary-color);
}

.detail-value {
  color: var(--text-secondary);
}

.seasons-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.season-item {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem;
  background-color: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

.episode-count {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.modal-actions {
  display: flex;
  gap: 1rem;
  margin-top: auto;
}

.modal-loading, .modal-error {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem;
  text-align: center;
}

.modal-error i {
  font-size: 3rem;
  color: #f87171;
  margin-bottom: 1rem;
}

/* Responsive styles */
@media (max-width: 992px) {
  .hero-title {
    font-size: 2.5rem;
  }

  .content-grid-view {
    grid-template-columns: repeat(6, 1fr);;
  }

  .content-card {
    flex: 0 0 calc(200px - 1rem);
    margin: 0 0.2rem;
    border-radius: var(--border-radius);
    overflow: hidden;
    position: relative;
    transition: transform var(--transition-speed);
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  .modal-header {
    gap: 1.5rem;
  }

  .auth-form-container {
    padding: 40px 30px;
  }
}

@media (max-width: 768px) {
  .nav-links {
    display: none;
  }
  
  .hero {
    height: 50vh;
  }
  
  .hero-title {
    font-size: 2rem;
  }
  
  .hero-description {
    font-size: 1rem;
  }
  
  .services-container {
    padding: 0.5rem 1rem; /* Reduce el padding en m√≥viles */
    gap: 0.5rem; /* Reduce el espacio entre elementos */
  }
  
  .service-name {
    font-size: 0.7rem; /* Reduce el tama√±o del texto en m√≥viles */
  }
  
  .content-grid-view {
    grid-template-columns: repeat(4, 1fr);;
  }

  .content-card {
    flex: 0 0 calc(180px - 1rem);
    margin: 0 0.2rem;
    border-radius: var(--border-radius);
    overflow: hidden;
    position: relative;
    transition: transform var(--transition-speed);
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  .modal-header {
    flex-direction: column;
    gap: 0.3rem;
  }
  
  .modal-poster {
    flex: 0 0 auto;
    max-width: 150px;
    margin: 0 auto;
  }
  
  .modal-title {
    font-size: 1.5rem;
  }

  .auth-form-container {
    padding: 30px 20px;
    width: 90%;
  }

  .admin-table {
    font-size: 0.9rem;
  }

  .admin-action-btn {
    padding: 4px 8px;
    font-size: 0.7rem;
  }

.admin-table th, .admin-table td {
  display: flex;
  padding: 8px 10px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}
}

@media (max-width: 460px) {
  .content-card {
    flex: 0 0 calc(130px - 1rem);
    margin: 0 0.2rem;
    border-radius: var(--border-radius);
    overflow: hidden;
    position: relative;
    transition: transform var(--transition-speed);
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

.section-title {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  padding-left: 0.5rem;
  border-left: 4px solid var(--secondary-color);
}

.logo-text {
  font-size: 1rem;
  font-weight: 800;
  background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

  .btn {
    padding: 0.8rem 1rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.8rem;
    transition: all var(--transition-speed);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .modal-content {
    padding: 0.5rem;
  }
  
  .modal-genres {
    gap: 0.3rem;
  }
  
  .modal-genre {
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
  }

  .content-grid-view {
    grid-template-columns: repeat(3, 1fr);
  }

  .auth-form-container {
    padding: 20px 15px;
  }

  .auth-title {
    font-size: 1.5rem;
  }

  .admin-table th, .admin-table td {
    padding: 8px 10px;
  }

  .admin-action-btn {
    margin-bottom: 5px;
  }
.admin-table th, .admin-table td {
  display: flex;
  padding: 8px 10px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}
}
/* A√±ade estos estilos para lazy loading */
img.lazy {
  opacity: 0;
  transition: opacity 0.3s;
}

img.lazy.loaded {
  opacity: 1;
}

.content-placeholder {
  background-color: #252525;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  width: 100%;
  height: 100%;
  min-height: 200px;
}
</style>
</head>
<body>
<!-- Loading spinner -->
<div class="spinner-container" id="spinner-container">
<div class="spinner"></div>
</div>

<!-- Authentication Container -->
<div class="auth-container" id="auth-container">
<div class="auth-form-container">
  <div class="auth-logo">
    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhqC8k7QO6KNqYZXNkGt-F0knO2XMq4VDjl0_sM6sbPa3FEt4_PyIs3oiThacqu1-jG7-8v7a14KGcjn8_YBEI33yLlrmcobGnt-TT9_TNMie71bwN_d9fSX6WTHSv4gtZgtN8CRyTIey5fRLOEFQmoYQ-bZImSBQXfvL6vMlJ55WORvg/s1600/StreamFusion.png" alt="StreamFusion">
    <h1>StreamFusion</h1>
  </div>
  
  <!-- Login Form -->
  <div id="login-form-container">
    <h2 class="auth-title">Iniciar Sesi√≥n</h2>
    <form id="login-form" class="auth-form">
      <div class="form-group">
        <input type="email" id="login-email" class="form-input" placeholder="Correo electr√≥nico" required>
      </div>
      <div class="form-group">
        <input type="password" id="login-password" class="form-input" placeholder="Contrase√±a" required>
      </div>
      <div id="login-error" class="auth-error" style="display: none;"></div>
      <button type="submit" class="auth-btn">Iniciar Sesi√≥n</button>
    </form>
    <div class="auth-switch">
      ¬øNo tienes una cuenta?<a id="show-register">Reg√≠strate</a>
    </div>
  </div>
  
  <!-- Register Form -->
  <div id="register-form-container" style="display: none;">
    <h2 class="auth-title">Crear Cuenta</h2>
    <form id="register-form" class="auth-form">
      <div class="form-group">
        <input type="text" id="register-name" class="form-input" placeholder="Nombre completo" required>
      </div>
      <div class="form-group">
        <input type="email" id="register-email" class="form-input" placeholder="Correo electr√≥nico" required>
      </div>
      <div class="form-group">
        <input type="password" id="register-password" class="form-input" placeholder="Contrase√±a" required>
      </div>
      <div class="form-group">
        <input type="password" id="register-confirm-password" class="form-input" placeholder="Confirmar contrase√±a" required>
      </div>
      <div id="register-error" class="auth-error" style="display: none;"></div>
      <div id="register-success" class="auth-success" style="display: none;"></div>
      <button type="submit" class="auth-btn">Registrarse</button>
    </form>
    <div class="auth-switch">
      ¬øYa tienes una cuenta?<a id="show-login">Inicia sesi√≥n</a>
    </div>
  </div>
</div>
</div>

<!-- Header -->
<header id="header">
<div class="logo-container">
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhqC8k7QO6KNqYZXNkGt-F0knO2XMq4VDjl0_sM6sbPa3FEt4_PyIs3oiThacqu1-jG7-8v7a14KGcjn8_YBEI33yLlrmcobGnt-TT9_TNMie71bwN_d9fSX6WTHSv4gtZgtN8CRyTIey5fRLOEFQmoYQ-bZImSBQXfvL6vMlJ55WORvg/s1600/StreamFusion.png" alt="StreamFusion" class="logo-img">
  <h1 class="logo-text">StreamFusion</h1>
</div>

<nav class="nav-links">
  <a href="#" class="nav-link active" data-section="home">Inicio</a>
  <a href="#" class="nav-link" data-section="movies">Pel√≠culas</a>
  <a href="#" class="nav-link" data-section="series">Series</a>
  <a href="#" class="nav-link" data-section="animes">Animes</a>
  <a href="#" class="nav-link" data-section="doramas">Doramas</a>
  <a href="go:TV" target="_blank">TV</a>
</nav>

<div class="header-actions">
  <div class="search-container">
    <input type="text" id="search-input" class="search-input" placeholder="Buscar t√≠tulos...">
    <button id="search-btn" class="search-btn">
      <i class="fas fa-search"></i>
    </button>
  </div>
  <div class="user-profile" id="user-profile">
    <div class="profile-icon" id="profile-icon">
      <i class="fas fa-user"></i>
    </div>
    <div class="profile-dropdown" id="profile-dropdown">
      <div class="profile-dropdown-item" id="view-profile">
        <i class="fas fa-user-circle"></i>
        <span>Mi Perfil</span>
      </div>
      <div class="profile-dropdown-item" id="admin-panel-link" style="display: none;">
        <i class="fas fa-cog"></i>
        <span>Panel de Admin</span>
      </div>
      <div class="profile-dropdown-item" id="logout-btn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Cerrar Sesi√≥n</span>
      </div>
    </div>
  </div>
  <button id="sidebar-toggle" class="menu-toggle">
    <i class="fas fa-bars"></i>
  </button>
</div>
</header>

<!-- Home View -->
<div id="home-view" class="page-view active">
<!-- Hero section -->
<section class="hero" id="hero">
  <!-- Los slides se generar√°n din√°micamente -->
</section>

<!-- Main content -->
<div class="main-container">
  <!-- Streaming services -->
  <div class="services-container" id="streaming-services">
    <!-- Added: Back button for mobile view -->
    <button class="services-back-btn" id="services-back-btn">
      <i class="fas fa-arrow-left"></i> Volver a inicio
    </button>
    
    <div class="service-item" data-service="netflix">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/69/Netflix_logo.svg" alt="Netflix" class="service-logo">
      <span class="service-name">Netflix</span>
    </div>
    <div class="service-item" data-service="disney">
      <img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/Disney%2B_logo.svg" alt="Disney+" class="service-logo">
      <span class="service-name">Disney+</span>
    </div>
    <div class="service-item" data-service="hbo">
      <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Max_logo.svg" alt="HBO Max" class="service-logo">
      <span class="service-name">HBO Max</span>
    </div>
    <div class="service-item" data-service="prime">
      <img src="https://cdn.worldvectorlogo.com/logos/amazon-prime-video-1.svg" alt="Prime Video" class="service-logo">
      <span class="service-name">Prime</span>
    </div>
    <div class="service-item" data-service="paramount">
      <img src="https://upload.wikimedia.org/wikipedia/commons/9/90/Paramount_Pictures_Corporation_logo.svg" alt="Paramount+" class="service-logo">
      <span class="service-name">Paramount+</span>
    </div>
  </div>

<!-- Recently Added content -->
<section class="content-row">
  <div class="row-header">
    <h2 class="section-title">Reci√©n Agregado</h2>
    <a href="#" class="see-all">Ver todo <i class="fas fa-chevron-right"></i></a>
  </div>
  <div class="content-slider">
    <div class="slider-container" id="recently-added-slider">
      <!-- Content will be dynamically generated -->
    </div>
    <div class="slider-controls">
      <button class="slider-arrow slider-prev">
        <i class="fas fa-chevron-left"></i>
      </button>
      <button class="slider-arrow slider-next">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</section>

  <!-- Trending content -->
  <section class="content-row">
    <div class="row-header">
      <h2 class="section-title">Tendencias</h2>
      <a href="#" class="see-all">Ver todo <i class="fas fa-chevron-right"></i></a>
    </div>
    <div class="content-slider">
      <div class="slider-container" id="trending-slider">
        <!-- Content will be dynamically generated -->
      </div>
      <div class="slider-controls">
        <button class="slider-arrow slider-prev">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="slider-arrow slider-next">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </section>

  <!-- Popular movies -->
  <section class="content-row">
    <div class="row-header">
      <h2 class="section-title">Pel√≠culas populares</h2>
      <a href="#" class="see-all" id="see-all-movies">Ver todo <i class="fas fa-chevron-right"></i></a>
    </div>
    <div class="content-slider">
      <div class="slider-container" id="movies-slider">
        <!-- Content will be dynamically generated -->
      </div>
      <div class="slider-controls">
        <button class="slider-arrow slider-prev">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="slider-arrow slider-next">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </section>

  <!-- Popular series -->
  <section class="content-row">
    <div class="row-header">
      <h2 class="section-title">Series populares</h2>
      <a href="#" class="see-all" id="see-all-series">Ver todo <i class="fas fa-chevron-right"></i></a>
    </div>
    <div class="content-slider">
      <div class="slider-container" id="series-slider">
        <!-- Content will be dynamically generated -->
      </div>
      <div class="slider-controls">
        <button class="slider-arrow slider-prev">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="slider-arrow slider-next">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </section>
</div>
</div>

<!-- Movies View -->
<div id="movies-view" class="page-view">
<div class="main-container">
  <div class="page-header">
    <h1 class="page-title">Pel√≠culas</h1>
    <button class="back-button" id="back-from-movies">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
  <div class="content-grid-view" id="movies-grid">
    <!-- Content will be dynamically generated -->
  </div>
</div>
</div>

<!-- Series View -->
<div id="series-view" class="page-view">
<div class="main-container">
  <div class="page-header">
    <h1 class="page-title">Series</h1>
    <button class="back-button" id="back-from-series">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
  <div class="content-grid-view" id="series-grid">
    <!-- Content will be dynamically generated -->
  </div>
</div>
</div>

<!-- Animes View -->
<div id="animes-view" class="page-view">
<div class="main-container">
  <div class="page-header">
    <h1 class="page-title">Animes</h1>
    <button class="back-button" id="back-from-animes">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
  <div class="content-grid-view" id="animes-grid">
    <!-- Content will be dynamically generated -->
  </div>
</div>
</div>

<!-- Doramas View -->
<div id="doramas-view" class="page-view">
<div class="main-container">
  <div class="page-header">
    <h1 class="page-title">Doramas</h1>
    <button class="back-button" id="back-from-doramas">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
  <div class="content-grid-view" id="doramas-grid">
    <!-- Content will be dynamically generated -->
  </div>
</div>
</div>

<!-- User Profile Page -->
<div id="user-profile-page" class="user-profile-page">
<div class="main-container">
  <div class="page-header">
    <h1 class="page-title">Mi Perfil</h1>
    <button class="back-button" id="back-from-profile">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
  
  <div class="profile-header">
    <div class="profile-avatar" id="profile-avatar">
      <!-- Will be filled dynamically -->
    </div>
    <div class="profile-info">
      <h2 id="profile-name">Nombre de Usuario</h2>
      <p id="profile-email">usuario@ejemplo.com</p>
    </div>
  </div>
  
  <div class="profile-tabs">
    <div class="profile-tab active" data-tab="info">Informaci√≥n</div>
    <div class="profile-tab" data-tab="my-list">Mi Lista</div>
    <div class="profile-tab" data-tab="messages">Mensajes</div>
  </div>
  
  <div class="profile-content">
    <!-- Info Section -->
    <div class="profile-section active" id="info-section">
      <div class="profile-detail">
        <label>Nombre:</label>
        <p id="info-name">Nombre de Usuario</p>
      </div>
      <div class="profile-detail">
        <label>Correo electr√≥nico:</label>
        <p id="info-email">usuario@ejemplo.com</p>
      </div>
      <div class="profile-detail">
        <label>Fecha de registro:</label>
        <p id="info-date">01/01/2023</p>
      </div>
    </div>
    
    <!-- My List Section -->
    <div class="profile-section" id="my-list-section">
      <div class="content-grid-view" id="profile-my-list-grid">
        <!-- Content will be dynamically generated -->
      </div>
    </div>
    
    <!-- Messages Section -->
    <div class="profile-section" id="messages-section">
      <div class="messages-list" id="messages-list">
        <!-- Messages will be dynamically generated -->
        <div class="no-messages" id="no-messages">
          <p>No tienes mensajes nuevos</p>
        </div>
      </div>
      
      <!-- User Message Form (NEW) -->
      <div class="user-message-form" id="user-message-form">
        <h3>Enviar mensaje al administrador</h3>
        <textarea id="user-message-content" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
        <div class="message-limit-info" id="message-limit-info">
          Puedes enviar hasta 2 mensajes por d√≠a.
        </div>
        <button id="send-user-message-btn" type="button">Enviar mensaje</button>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Admin Panel -->
<div id="admin-panel" class="admin-panel">
<div class="main-container">
  <div class="page-header">
    <h1 class="page-title">Panel de Administrador</h1>
    <button class="back-button" id="back-from-admin">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
  
  <div class="admin-tabs">
    <div class="admin-tab active" data-tab="users">Usuarios</div>
    <div class="admin-tab" data-tab="messages">Mensajes</div>
  </div>
  
  <div class="admin-content">
    <!-- Users Section -->
    <div class="admin-section active" id="users-section">
      <table class="admin-table" id="users-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Fecha de registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Users will be dynamically generated -->
        </tbody>
      </table>
    </div>
    
    <!-- Messages Section -->
    <div class="admin-section" id="messages-section">
      <form id="admin-message-form" class="admin-form">
        <div class="form-group">
          <label>Destinatario:</label>
          <select id="message-recipient" class="form-input">
            <option value="all">Todos los usuarios</option>
            <!-- Other options will be dynamically generated -->
          </select>
        </div>
        <div class="form-group">
          <label>Mensaje:</label>
          <textarea id="message-content" class="form-input" placeholder="Escribe tu mensaje aqu√≠..." required></textarea>
        </div>
        <button type="submit" class="auth-btn">Enviar Mensaje</button>
      </form>
      
      <!-- Admin Messages List (NEW) -->
      <div class="admin-messages-container" style="margin-top: 30px;">
        <h3 style="margin-bottom: 15px; color: var(--secondary-color);">Mensajes Recibidos</h3>
        <div class="messages-list" id="admin-messages-list">
          <!-- Messages will be dynamically generated -->
          <div class="no-messages" id="admin-no-messages">
            <p>No hay mensajes recibidos</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Genre Results View -->
<div id="genre-results-view" class="page-view">
<div class="main-container">
  <div class="page-header">
    <h1 class="page-title" id="genre-title">Resultados por G√©nero</h1>
    <button class="back-button" id="back-from-genre">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
  <div class="content-grid-view" id="genre-results-grid">
    <!-- Content will be dynamically generated -->
  </div>
</div>
</div>

<!-- Search Results View -->
<div id="search-results-view" class="page-view">
<div class="main-container">
  <div class="page-header">
    <h1 class="page-title" id="search-results-title">Resultados de b√∫squeda</h1>
    <button class="back-button" id="back-from-search">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
  <div class="content-grid-view" id="search-results-grid">
    <!-- Content will be dynamically generated -->
  </div>
</div>
</div>

<!-- Genre sidebar -->
<div class="sidebar" id="sidebar">
<div class="sidebar-header">
  <h2 class="sidebar-title">Men√∫</h2>
  <button class="close-sidebar" id="close-sidebar">
    <i class="fas fa-times"></i>
  </button>
  </div>
<ul class="genre-list" id="genre-list">
  <li class="menu-item">
    <i class="fa-solid fa-house genre-icon"></i><a href="#" class="nav-link active" data-section="home">Inicio</a>
  </li>
  <li class="menu-item">
    <i class="fa-solid fa-tv genre-icon"></i><a href="go:TV" target="_blank">TV</a>
  </li>
  <li class="menu-item">
    <i class="fa-solid fa-film genre-icon"></i><a href="#" class="nav-link" data-section="movies">Pel√≠culas</a>
  </li>
  <li class="menu-item">
    <i class="fa-solid fa-clapperboard genre-icon"></i><a href="#" class="nav-link" data-section="series">Series</a>
  </li>
  <li class="menu-item">
    <i class="fa-solid fa-a genre-icon"></i><a href="#" class="nav-link" data-section="animes">Animes</a>
  </li>
  <li class="menu-item">
    <i class="fa-solid fa-masks-theater genre-icon"></i><a href="#" class="nav-link" data-section="doramas">Doramas</a>
  </li>
 </ul>
<div class="sidebar-header">
  <h2 class="sidebar-title">G√©neros</h2>
</div>
<ul class="genre-list" id="genre-list">
  <li class="genre-item" data-genre="28">
    <i class="fas fa-fire genre-icon"></i>Acci√≥n
  </li>
  <li class="genre-item" data-genre="12">
    <i class="fas fa-compass genre-icon"></i>Aventura
  </li>
  <li class="genre-item" data-genre="16">
    <i class="fas fa-child genre-icon"></i>Animaci√≥n
  </li>
  <li class="genre-item" data-genre="35">
    <i class="fas fa-laugh genre-icon"></i>Comedia
  </li>
  <li class="genre-item" data-genre="80">
    <i class="fas fa-mask genre-icon"></i>Crimen
  </li>
  <li class="genre-item" data-genre="878">
    <i class="fas fa-rocket genre-icon"></i>Ciencia Ficci√≥n
  </li>
  <li class="genre-item" data-genre="18">
    <i class="fas fa-theater-masks genre-icon"></i>Drama
  </li>
  <li class="genre-item" data-genre="10751">
    <i class="fas fa-home genre-icon"></i>Familia
  </li>
  <li class="genre-item" data-genre="14">
    <i class="fas fa-hat-wizard genre-icon"></i>Fantas√≠a
  </li>
  <li class="genre-item" data-genre="36">
    <i class="fas fa-landmark genre-icon"></i>Historia
  </li>
  <li class="genre-item" data-genre="10402">
    <i class="fas fa-music genre-icon"></i>M√∫sica
  </li>
  <li class="genre-item" data-genre="9648">
    <i class="fas fa-search genre-icon"></i>Misterio
  </li>
  <li class="genre-item" data-genre="10749">
    <i class="fas fa-heart genre-icon"></i>Romance
  </li>
  <li class="genre-item" data-genre="27">
    <i class="fas fa-ghost genre-icon"></i>Terror
  </li>
  <li class="genre-item" data-genre="53">
    <i class="fas fa-exclamation-triangle genre-icon"></i>Suspenso
  </li>
  <li class="genre-item" data-genre="10752">
    <i class="fas fa-fighter-jet genre-icon"></i>B√©lica
  </li>
</ul>
</div>
<div class="overlay" id="overlay"></div>

<!-- Back to top button -->
<button id="back-to-top" class="back-to-top">
<i class="fas fa-arrow-up"></i>
</button>

<!-- Welcome popup -->
<div class="welcome-popup" id="welcome-popup" style="display: none;">
<div class="popup-content">
  <div class="popup-header">
    <h2 class="popup-title">
      Bienvenido a <span>Stream</span><span>Fusion</span>
    </h2>
    <p class="popup-subtitle">Tu plataforma de entretenimiento streaming</p>
  </div>
  <div class="popup-body">
    <div class="popup-section">
      <p class="popup-text">StreamFusion es una app Gratuita de Entretenimiento Streaming que te permite disfrutar de todo tu contenido favorito en un solo lugar.</p>
    </div>
    <div class="popup-section">
      <h3 class="popup-section-title">IMPORTANTE</h3>
      <p class="popup-text">Sabemos que los anuncios en las apps son un poco molestos, pero es la manera de sostener la app para brindarte un servicio de contenido gratuito.</p>
      <p class="popup-text">StreamFusion solo cuenta con 2 anuncios: üòä uno que aparecer√° cuando inicies la Aplicaci√≥n, y otro que se activara √∫nicamente si deseas hacer una petici√≥n de contenido, en la secci√≥n de <strong>S/R (Solicitud/Reporte)</strong></p>
    </div>
    <div class="popup-section">
      <p class="popup-text">No siendo m√°s disfruta del contenido. üéâ</p>
    </div>
  </div>
  <div class="popup-footer">
    <div class="dont-show-again">
      <label class="checkbox-container">
        <input type="checkbox" id="dont-show-again" class="custom-checkbox">
        <span class="checkmark"></span>
      </label>
      <span>No mostrar m√°s</span>
    </div>
    <button id="close-popup" class="close-popup-btn">Comenzar a explorar</button>
  </div>
</div>
</div>

<!-- Movie Details Modal Container -->
<div id="movie-details-modal-container"></div>

<!-- Trailer Modal Container -->
<div id="trailer-modal-container"></div>

<!-- Edit User Modal -->
<div id="edit-user-modal" style="display: none;">
<div class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">Editar Usuario</h3>
      <span class="modal-close" id="close-edit-modal">√ó</span>
    </div>
    <div class="modal-body">
      <form id="edit-user-form" class="modal-form">
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" id="edit-name" class="form-input" required>
        </div>
        <div class="form-group">
          <label>Correo electr√≥nico:</label>
          <input type="email" id="edit-email" class="form-input" required>
        </div>
        <input type="hidden" id="edit-user-id">
      </form>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" id="cancel-edit">Cancelar</button>
      <button class="modal-btn modal-btn-primary" id="save-edit">Guardar</button>
    </div>
  </div>
</div>
</div>

<!-- Send Message Modal -->
<div id="send-message-modal" style="display: none;">
<div class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">Enviar Mensaje</h3>
      <span class="modal-close" id="close-message-modal">√ó</span>
    </div>
    <div class="modal-body">
      <form id="send-message-form" class="modal-form">
        <div class="form-group">
          <label>Para:</label>
          <input type="text" id="message-to" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label>Mensaje:</label>
          <textarea id="individual-message-content" class="form-input" placeholder="Escribe tu mensaje aqu√≠..." required></textarea>
        </div>
        <input type="hidden" id="message-user-id">
      </form>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" id="cancel-message">Cancelar</button>
      <button class="modal-btn modal-btn-primary" id="send-message">Enviar</button>
    </div>
  </div>
</div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirmation-modal" style="display: none;">
<div class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">Confirmar Eliminaci√≥n</h3>
      <span class="modal-close" id="close-delete-modal">√ó</span>
    </div>
    <div class="modal-body">
      <p>¬øEst√°s seguro de que deseas eliminar este usuario? Esta acci√≥n no se puede deshacer.</p>
      <input type="hidden" id="delete-user-id">
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" id="cancel-delete">Cancelar</button>
      <button class="modal-btn modal-btn-primary" id="confirm-delete">Eliminar</button>
    </div>
  </div>
</div>
</div>

<!-- Delete Message Confirmation Modal (NEW) -->
<div id="delete-message-modal" style="display: none;">
<div class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">Confirmar Eliminaci√≥n</h3>
      <span class="modal-close" id="close-delete-message-modal">√ó</span>
    </div>
    <div class="modal-body">
      <p>¬øEst√°s seguro de que deseas eliminar este mensaje? Esta acci√≥n no se puede deshacer.</p>
      <input type="hidden" id="delete-message-id">
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" id="cancel-delete-message">Cancelar</button>
      <button class="modal-btn modal-btn-primary" id="confirm-delete-message">Eliminar</button>
    </div>
  </div>
</div>
</div>

<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
import { GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyBrNnQQcKOpaZguVF4myX8TSQseh5sQf8s",
authDomain: "proyecto-licencia-adf0f.firebaseapp.com",
projectId: "proyecto-licencia-adf0f",
storageBucket: "proyecto-licencia-adf0f.firebasestorage.app",
messagingSenderId: "632117204154",
appId: "1:632117204154:web:b73b5a1a39457fbb47de83",
measurementId: "G-LXFTJXCNF3"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);
const apiCache = new Map();

// API Configuration
const API_KEY = '32e5e53999e380a0291d66fb304153fe';
const API_BASE_URL = 'https://api.themoviedb.org/3';
const IMG_BASE_URL = 'https://image.tmdb.org/t/p';

// IDs destacados para el hero slider
const featuredMovieIds = [762509, 166428]; // Dune: Part Two, Interstellar
const featuredSeriesIds = [114477, 235930]; // Demon Slayer, Game of Thrones 

// Content IDs for different categories
const contentIds = {
recentlyAddedIds: {
  movies: [390634, 29917, 10191, 82702, 166428, 950387, 1255788, 1014505, 1197306, 447273], // Agrega aqu√≠ los IDs de pel√≠culas reci√©n agregadas
  series: [123876, 249042, 46298, 235930, 65844] // Agrega aqu√≠ los IDs de series reci√©n agregadas
},
  // Pel√≠culas populares - IDs ampliados para tener m√°s variedad 
      inicioMovieIds: [390634, 29917, 988078, 1139566, 10191, 82702, 166428, 950387, 1255788, 1014505, 1197306, 777443, 1333099, 447273, 9053, 762509, 117251, 117263, 974576, 950396, 921436, 76338, 616037, 10195, 1405338, 822119, 1241982, 993710, 851644, 500664, 530254, 615173, 823219, 1357633, 12477, 402431, 558449, 539972, 939243, 1184918, 912649, 157350, 262500, 262504, 9316, 43209, 11238, 297761, 436969, 508442, 530915, 49046, 497582, 829280, 700391, 315162, 632856, 338958, 605886, 620705, 455476, 816904, 748167, 456740, 11253, 354912, 929590, 365177, 588228, 61979, 818647, 646097, 961323, 413518, 532639, 555604, 10895, 862, 863, 10193, 301528, 213121, 256835, 594530, 15167, 168903, 13002, 1729, 957452, 917496, 346698, 250546, 396422, 521029,37135, 258489, 230222, 13683, 15657, 22794, 109451, 8960, 832502, 254, 177572, 8587, 9732, 420818, 11430, 9502, 49444, 140300, 10601, 10693, 420808, 16690, 381719, 522478, 11970, 184315, 505026, 512195, 329996, 11224, 14128, 16119, 150689, 13179, 297270, 44683, 175112, 25475, 75258, 614409, 565426, 466282, 15213, 545611, 118, 458897, 9471, 4327, 240832, 1979, 166424, 22832, 133805, 7342, 1075794, 71676, 1250],
      // Series populares - IDs ampliados para tener m√°s variedad
      inicioSeriesIds: [123876, 235930, 65844, 114477, 108978, 194764, 249042, 240576, 46298, 71024, 94664, 121964, 72505, 213402, 259140, 261298, 240633, 65945, 236994, 238843, 221851, 112163, 99966, 253905, 94605, 99778, 138501, 226529, 125988, 207332, 108284, 74189, 85271, 60863, 74682, 76758, 85723, 208730, 98986, 45782, 128839, 133903, 114410, 67075, 158300, 63174, 60808, 63767, 5178, 154825, 112888, 258707, 214999, 158141, 90660, 131041, 232616, 204832, 229480, 201834, 102621, 80752, 84773, 239287, 42503, 120734, 62110, 230424, 45666, 219652, 203164, 197067, 48866, 259730, 202506, 156902, 2038, 110418, 1396, 108545, 71446, 110356, 84958, 82452, 92749, 60625, 93405, 231749, 82856, 1399, 66732, 60574, 226527, 215720, 60735, 218539, 5371, 52814, 1403, 119243, 94997, 39351, 76479, 198004, 94796, 60957, 67915, 96160, 62745, 114868, 202284, 218843, 117884, 62104, 120089, 83095, 235389, 205050, 82684, 69346, 85844, 127532, 97860, 85937, 63926, 95479, 207468, 1429, 64196, 121078],
      netflixMovieIds: [818647, 988078, 1139566, 993710, 851644, 49046, 497582, 829280, 748167, 646097, 961323, 555604, 832502, 177572, 512195, 614409, 565426, 466282, 1075794, 960704, 1151534, 831815, 1231574, 1001311, 488623, 667520, 955916, 664413, 829560, 829557, 1026999, 280180, 1134433, 829402, 984324, 1291559, 739547, 974635, 727745, 550205, 704673, 614933, 987686, 1025463, 400160, 934632, 848326, 454983, 583083, 569094],
      netflixSeriesIds: [123876, 235930, 249042, 71024, 207332, 99966, 253905, 94605, 208730, 63174, 154825, 258707, 214999, 158141, 90660, 232616, 102621, 219652, 197067, 48866, 259730, 114868, 156902, 218843, 62104, 110418, 108545, 71446, 110356, 82452, 93405, 215720, 203164, 231749, 242876, 96160, 226527, 198004, 218539],
      disneyMovieIds: [447273, 762509, 1241982, 11238, 508442, 338958, 620705, 354912, 10895, 862, 863, 10193, 301528, 213121, 256835, 594530, 37135, 15657, 11430, 10693, 420808, 16690, 11970, 329996, 11360, 11224, 14128, 16119, 150689, 13179, 297270, 44683, 175112, 25475, 75258, 447277, 10681, 62177, 38757, 568124, 974262, 277834, 9806, 109445, 260513, 150540, 330457, 76600, 527774, 293660, 269149, 1022796, 1022789, 976573],
      disneySeriesIds: [138501, 120734, 84958, 1403, 92749, 82856],
      hboMovieIds: [693134, 872585, 787699, 438631, 565770, 76341],
      hboSeriesIds: [194764, 94997, 1399],
      primeMovieIds: [1255788, 588228, 1094138, 1010581, 1019411, 1029528, 359410, 629176, 593910],
      primeSeriesIds: [108978, 84773, 76479],
      paramountMovieIds: [558449, 831815, 639720, 466420, 335977, 575264],
      paramountSeriesIds: [158300, 52814, 5371, 119243],
      doramasSeriesIds: [221851, 99966, 253905, 226529, 108284, 74682, 63767, 5178, 154825, 112888, 258707, 214999, 229480, 232616, 219652, 203164, 197067, 218539, 110356, 226527, 215720, 231749, 198004, 94796, 60957, 67915, 96160],
      doramasMovieIds: [1405338, 851644, 1291559, 488623],
      animesSeriesIds: [123876, 235930, 65844, 114477, 240576, 46298, 94664, 121964, 72505, 213402, 259140, 261298, 240633, 65945, 236994, 238843, 112163, 94605, 99778, 207332, 74189, 60863, 76758, 208730, 98986, 45782, 114410, 67075, 60808, 131041, 204832, 239287, 42503, 62110, 62745, 114868, 202284, 218843, 117884, 62104, 120089, 83095, 235389, 205050, 82684, 69346, 85844, 127532, 97860, 85937, 63926, 95479, 207468, 1429, 64196, 121078],
      animesMovieIds: [390634, 1014505, 12477, 1357633, 579741, 1231574, 916224, 445030, 680041, 372058, 667520, 79707, 876792]
};

// DOM Elements - Authentication
const authContainer = document.getElementById('auth-container');
const loginFormContainer = document.getElementById('login-form-container');
const registerFormContainer = document.getElementById('register-form-container');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const loginEmail = document.getElementById('login-email');
const loginPassword = document.getElementById('login-password');
const registerName = document.getElementById('register-name');
const registerEmail = document.getElementById('register-email');
const registerPassword = document.getElementById('register-password');
const registerConfirmPassword = document.getElementById('register-confirm-password');
const loginError = document.getElementById("login-error")
const registerError = document.getElementById("register-error")
const registerSuccess = document.getElementById('register-success');
const showRegister = document.getElementById('show-register');
const showLogin = document.getElementById('show-login');

// DOM Elements - Main App
const spinnerContainer = document.getElementById('spinner-container');
const header = document.getElementById('header');
const searchBtn = document.getElementById('search-btn');
const searchInput = document.getElementById('search-input');
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');
const closeSidebar = document.getElementById('close-sidebar');
const overlay = document.getElementById('overlay');
const genreItems = document.querySelectorAll('.genre-item');
const backToTopBtn = document.getElementById('back-to-top');
const welcomePopup = document.getElementById('welcome-popup');
const closePopup = document.getElementById('close-popup');
const dontShowAgain = document.getElementById('dont-show-again');
const serviceItems = document.querySelectorAll('.service-item');
const hero = document.getElementById('hero');
const trendingSlider = document.getElementById('trending-slider');
const moviesSlider = document.getElementById('movies-slider');
const seriesSlider = document.getElementById('series-slider');
const sliderPrevBtns = document.querySelectorAll('.slider-prev');
const sliderNextBtns = document.querySelectorAll('.slider-next');
const servicesBackBtn = document.getElementById('services-back-btn');

// DOM Elements - User Profile
const userProfile = document.getElementById('user-profile');
const profileIcon = document.getElementById('profile-icon');
const profileDropdown = document.getElementById('profile-dropdown');
const viewProfile = document.getElementById('view-profile');
const adminPanelLink = document.getElementById('admin-panel-link');
const logoutBtn = document.getElementById('logout-btn');
const userProfilePage = document.getElementById('user-profile-page');
const profileAvatar = document.getElementById('profile-avatar');
const profileName = document.getElementById('profile-name');
const profileEmail = document.getElementById('profile-email');
const infoName = document.getElementById('info-name');
const infoEmail = document.getElementById('info-email');
const infoDate = document.getElementById('info-date');
const profileTabs = document.querySelectorAll('.profile-tab');
const profileSections = document.querySelectorAll('.profile-section');
const profileMyListGrid = document.getElementById('profile-my-list-grid');
const messagesList = document.getElementById('messages-list');
const noMessages = document.getElementById('no-messages');
const backFromProfile = document.getElementById('back-from-profile');

// DOM Elements - User Message Form
const userMessageForm = document.getElementById('user-message-form');
const userMessageContent = document.getElementById('user-message-content');
const sendUserMessageBtn = document.getElementById('send-user-message-btn');
const messageLimitInfo = document.getElementById('message-limit-info');

// DOM Elements - Admin Panel
const adminPanel = document.getElementById('admin-panel');
const adminTabs = document.querySelectorAll('.admin-tab');
const adminSections = document.querySelectorAll('.admin-section');
const usersTable = document.getElementById('users-table');
const adminMessageForm = document.getElementById('admin-message-form');
const messageRecipient = document.getElementById('message-recipient');
const messageContent = document.getElementById('message-content');
const backFromAdmin = document.getElementById('back-from-admin');

// DOM Elements - Admin Messages List (NEW)
const adminMessagesList = document.getElementById('admin-messages-list');
const adminNoMessages = document.getElementById('admin-no-messages');

// DOM Elements - Modals
const editUserModal = document.getElementById('edit-user-modal');
const editUserForm = document.getElementById('edit-user-form');
const editName = document.getElementById('edit-name');
const editEmail = document.getElementById('edit-email');
const editUserId = document.getElementById('edit-user-id');
const closeEditModal = document.getElementById('close-edit-modal');
const cancelEdit = document.getElementById('cancel-edit');
const saveEdit = document.getElementById('save-edit');
const sendMessageModal = document.getElementById('send-message-modal');
const sendMessageForm = document.getElementById('send-message-form');
const messageTo = document.getElementById('message-to');
const individualMessageContent = document.getElementById('individual-message-content');
const messageUserId = document.getElementById('message-user-id');
const closeMessageModal = document.getElementById('close-message-modal');
const cancelMessage = document.getElementById('cancel-message');
const sendMessage = document.getElementById('send-message');
const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
const deleteUserId = document.getElementById('delete-user-id');
const closeDeleteModal = document.getElementById('close-delete-modal');
const cancelDelete = document.getElementById('cancel-delete');
const confirmDelete = document.getElementById('confirm-delete');

// DOM Elements - Delete Message Modal
const deleteMessageModal = document.getElementById('delete-message-modal');
const deleteMessageId = document.getElementById('delete-message-id');
const closeDeleteMessageModal = document.getElementById('close-delete-message-modal');
const cancelDeleteMessage = document.getElementById('cancel-delete-message');
const confirmDeleteMessage = document.getElementById('confirm-delete-message');

// View navigation elements
const navLinks = document.querySelectorAll('.nav-link');
const seeAllMovies = document.getElementById('see-all-movies');
const seeAllSeries = document.getElementById('see-all-series');
const backFromMovies = document.getElementById('back-from-movies');
const backFromSeries = document.getElementById('back-from-series');
const backFromAnimes = document.getElementById('back-from-animes');
const backFromDoramas = document.getElementById('back-from-doramas');
const backFromGenre = document.getElementById('back-from-genre');
const backFromSearch = document.getElementById('back-from-search');

// Views
const homeView = document.getElementById('home-view');
const moviesView = document.getElementById('movies-view');
const seriesView = document.getElementById('series-view');
const animesView = document.getElementById('animes-view');
const doramasView = document.getElementById('doramas-view');
const genreResultsView = document.getElementById('genre-results-view');
const searchResultsView = document.getElementById('search-results-view');

// Grids
const moviesGrid = document.getElementById('movies-grid');
const seriesGrid = document.getElementById('series-grid');
const animesGrid = document.getElementById('animes-grid');
const doramasGrid = document.getElementById('doramas-grid');
const genreResultsGrid = document.getElementById('genre-results-grid');
const searchResultsGrid = document.getElementById('search-results-grid');

const genreTitle = document.getElementById('genre-title');
const searchResultsTitle = document.getElementById('search-results-title');

// State variables
let currentCategory = 'inicio';
let currentService = null;
let currentGenre = null;
let currentHeroSlide = 0;
let heroInterval;
let trendingContent = [];
let moviesContent = [];
let seriesContent = [];
let continueWatchingContent = [];
let currentView = 'home';
let heroSlides = [];
let heroDots = [];
let currentUser = null;
let isAdmin = false;
let messageListeners = {}; // Para almacenar los listeners de mensajes

// Admin credentials
const ADMIN_EMAIL = 'javiervelasquez0618@gmail.com';

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
  initApp();
});

// Main initialization function
function initApp() {
  // Show spinner
  showSpinner();

  // Initialize authentication
  initAuth();

  // Initialize event listeners
  initEventListeners();
}

// Initialize authentication
// Initialize authentication
function initAuth() {
  // Ocultar el contenedor de autenticaci√≥n inicialmente
  // y mostrar el spinner mientras verificamos la autenticaci√≥n
  authContainer.style.display = 'none';
  showSpinner();
  
  // Check if user is already logged in
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // User is signed in
    try {
      // Get user data from Firestore
      const userDoc = await getDoc(doc(db, "users", user.uid));
      
      if (userDoc.exists()) {
        // C√≥digo existente para usuario que ya existe en Firestore
        currentUser = {
          id: user.uid,
          ...userDoc.data()
        };
        
        // Check if user is admin
        isAdmin = currentUser.email === ADMIN_EMAIL;
        
        // Mantener el contenedor de autenticaci√≥n oculto
        authContainer.style.display = 'none';
        
        // Update UI for logged in user
        updateUIForLoggedInUser();
        
        // Load content
        loadAllContent().then(() => {
          // Check welcome popup
          checkWelcomePopup();

          // Start hero slideshow
          startHeroSlideshow();
          
          // Hide spinner
          hideSpinner();
        });
      } else {
        // Usuario existe en Auth pero no en Firestore
        // Crear documento de usuario con datos de Google si est√° disponible
        await setDoc(doc(db, "users", user.uid), {
          name: user.displayName || user.email.split('@')[0],
          email: user.email,
          registeredAt: serverTimestamp(),
          myList: [],
          messagesSent: [] // Array para rastrear mensajes enviados por el usuario
        });
        
        // Get the newly created user
        const newUserDoc = await getDoc(doc(db, "users", user.uid));
        currentUser = {
          id: user.uid,
          ...newUserDoc.data()
        };
        
        isAdmin = currentUser.email === ADMIN_EMAIL;
        
        // Hide auth container and show app
        authContainer.style.display = 'none';
        
        // Update UI for logged in user
        updateUIForLoggedInUser();
        
        // Load content
        loadAllContent().then(() => {
          // Check welcome popup
          checkWelcomePopup();

          // Start hero slideshow
          startHeroSlideshow();
          
          // Hide spinner
          hideSpinner();
        });
      }
    } catch (error) {
      console.error("Error getting user data:", error);
      hideSpinner();
    }
  } else {
      // No user is signed in
      currentUser = null;
      isAdmin = false;
      
      // Ahora s√≠ mostramos el contenedor de autenticaci√≥n
      authContainer.style.display = 'flex';
      
      // Hide spinner
      hideSpinner();
    }
  });

  // Add event listeners for auth forms
  loginForm.addEventListener('submit', handleLogin);
  registerForm.addEventListener('submit', handleRegister);
  showRegister.addEventListener('click', () => {
    loginFormContainer.style.display = 'none';
    registerFormContainer.style.display = 'block';
  });
  showLogin.addEventListener('click', () => {
    registerFormContainer.style.display = 'none';
    loginFormContainer.style.display = 'block';
  });
}

function handleGoogleSignIn() {
  const provider = new GoogleAuthProvider()
  provider.setCustomParameters({
    prompt: "select_account",
  })

  signInWithPopup(auth, provider)
    .then((result) => {
      // Ocultar spinner mientras se procesa la autenticaci√≥n
      showSpinner()

      // El usuario se ha autenticado correctamente
      // onAuthStateChanged se encargar√° del resto
    })
    .catch((error) => {
      hideSpinner()
      console.error("Error en autenticaci√≥n con Google:", error)

      // Mostrar error en ambos formularios
      loginError.textContent = "Error al iniciar sesi√≥n con Google. Int√©ntalo de nuevo."
      loginError.style.display = "block"

      registerError.textContent = "Error al registrarse con Google. Int√©ntalo de nuevo."
      registerError.style.display = "block"
    })
}

// Handle login
async function handleLogin(e) {
  e.preventDefault();
  
  const email = loginEmail.value.trim();
  const password = loginPassword.value;
  
  // Show spinner
  showSpinner();
  
  try {
    // Sign in with Firebase Auth
    await signInWithEmailAndPassword(auth, email, password);
    
    // Clear form
    loginForm.reset();
    loginError.style.display = 'none';
  } catch (error) {
    // Hide spinner
    hideSpinner();
    
    // Show error
    loginError.textContent = getAuthErrorMessage(error.code);
    loginError.style.display = 'block';
  }
}

// Handle register
async function handleRegister(e) {
  e.preventDefault();
  
  const name = registerName.value.trim();
  const email = registerEmail.value.trim();
  const password = registerPassword.value;
  const confirmPassword = registerConfirmPassword.value;
  
  // Validate form
  if (password !== confirmPassword) {
    registerError.textContent = 'Las contrase√±as no coinciden';
    registerError.style.display = 'block';
    registerSuccess.style.display = 'none';
    return;
  }
  
  // Show spinner
  showSpinner();
  
  try {
    // Create user with Firebase Auth
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    // Add user data to Firestore
    await setDoc(doc(db, "users", user.uid), {
      name: name,
      email: email,
      registeredAt: serverTimestamp(),
      myList: [],
      messagesSent: [] // Array to track messages sent by the user
    });
    
    // Show success message
    registerError.style.display = 'none';
    registerSuccess.textContent = 'Registro exitoso. Iniciando sesi√≥n...';
    registerSuccess.style.display = 'block';
    
    // Clear form
    registerForm.reset();
    
    // Hide spinner (auth state change will handle the rest)
  } catch (error) {
    // Hide spinner
    hideSpinner();
    
    // Show error
    registerError.textContent = getAuthErrorMessage(error.code);
    registerError.style.display = 'block';
    registerSuccess.style.display = 'none';
  }
}

// Get auth error message
function getAuthErrorMessage(errorCode) {
  switch (errorCode) {
    case 'auth/email-already-in-use':
      return 'Este correo electr√≥nico ya est√° registrado';
    case 'auth/invalid-email':
      return 'Correo electr√≥nico inv√°lido';
    case 'auth/weak-password':
      return 'La contrase√±a debe tener al menos 6 caracteres';
    case 'auth/user-not-found':
    case 'auth/wrong-password':
      return 'Correo electr√≥nico o contrase√±a incorrectos';
    default:
      return 'Error de autenticaci√≥n: ' + errorCode;
  }
}

// Update UI for logged in user
function updateUIForLoggedInUser() {
  // Update profile icon
  if (currentUser) {
    // Show first letter of user's name in profile icon
    profileIcon.innerHTML = currentUser.name.charAt(0).toUpperCase();
    
    // Show admin panel link if user is admin
    if (isAdmin) {
      adminPanelLink.style.display = 'flex';
    } else {
      adminPanelLink.style.display = 'none';
    }
  }
}

// Initialize event listeners
function initEventListeners() {
  // Header scroll effect
window.addEventListener('scroll', throttle(() => {
  // Header scroll effect
  if (window.scrollY > 50) {
    header.classList.add('scrolled');
  } else {
    header.classList.remove('scrolled');
  }
  
  // Back to top button
  toggleBackToTop();
  
  // Inicializa lazy loading para im√°genes que entran en el viewport
  initLazyLoading();
}, 100));

window.addEventListener('resize', debounce(() => {
  // Ajusta los sliders si es necesario
  adjustSliders();
}, 200))

  // Search functionality
  searchBtn.addEventListener('click', toggleSearch);
  searchInput.addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
      handleSearch();
    }
  });
  searchInput.addEventListener('input', function() {
    // Only perform live search if the input has focus and has content
    if (document.activeElement === searchInput && searchInput.value.trim()) {
      handleSearch();
    }
  });
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-container') && searchInput.classList.contains('active')) {
      searchInput.classList.remove('active');
    }
  });

  // Sidebar functionality
  sidebarToggle.addEventListener('click', toggleSidebar);
  closeSidebar.addEventListener('click', closeSidebarHandler);
  overlay.addEventListener('click', closeSidebarHandler);

  // Genre selection
  genreItems.forEach(item => {
    item.addEventListener('click', handleGenreClick);
  });

  // Back to top button
  window.addEventListener('scroll', toggleBackToTop);
  backToTopBtn.addEventListener('click', scrollToTop);

  // Welcome popup
  closePopup.addEventListener('click', handleClosePopup);

  // Service selection
  serviceItems.forEach(item => {
    item.addEventListener('click', handleServiceClick);
  });

  // Services back button
  servicesBackBtn.addEventListener('click', resetServices);

  // Slider navigation
  sliderPrevBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const slider = this.closest('.content-slider').querySelector('.slider-container');
      navigateSlider(slider, 'prev');
    });
  });

  sliderNextBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const slider = this.closest('.content-slider').querySelector('.slider-container');
      navigateSlider(slider, 'next');
    });
  });

  // View navigation
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const section = this.dataset.section;
      navigateToView(section);
    });
  });

// A√±ade este c√≥digo despu√©s de los event listeners de navegaci√≥n
document.querySelectorAll('.sidebar .menu-item a, .sidebar .genre-item').forEach(item => {
  item.addEventListener('click', () => {
    closeSidebarHandler(); // Cierra el sidebar cuando se hace clic en un elemento del men√∫
  });
});

  // See all buttons
  seeAllMovies.addEventListener('click', function(e) {
    e.preventDefault();
    navigateToView('movies');
  });

  seeAllSeries.addEventListener('click', function(e) {
    e.preventDefault();
    navigateToView('series');
  });

  // Back buttons
  backFromMovies.addEventListener('click', () => navigateToView('home'));
  backFromSeries.addEventListener('click', () => navigateToView('home'));
  backFromAnimes.addEventListener('click', () => navigateToView('home'));
  backFromDoramas.addEventListener('click', () => navigateToView('home'));
  backFromGenre.addEventListener('click', () => navigateToView('home'));
  backFromSearch.addEventListener('click', () => navigateToView('home'));
  
  // User profile functionality
  profileIcon.addEventListener('click', () => {
    const wasOpen = profileDropdown.classList.contains('active');
    toggleProfileDropdown();
    
    // Si el dropdown se est√° abriendo, marcar mensajes como le√≠dos
    if (!wasOpen && profileDropdown.classList.contains('active')) {
      markMessagesAsRead();
    }
  });
  
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.user-profile') && profileDropdown.classList.contains('active')) {
      profileDropdown.classList.remove('active');
    }
  });
  
  viewProfile.addEventListener('click', () => {
    profileDropdown.classList.remove('active');
    showUserProfile();
  });
  
  adminPanelLink.addEventListener('click', () => {
    profileDropdown.classList.remove('active');
    showAdminPanel();
  });
  
  logoutBtn.addEventListener('click', handleLogout);
  
  backFromProfile.addEventListener('click', () => {
    userProfilePage.classList.remove('active');
    navigateToView('home');
  });
  
  backFromAdmin.addEventListener('click', () => {
    adminPanel.classList.remove('active');
    navigateToView('home');
  });
  
  // Profile tabs
  profileTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.dataset.tab;
      
      // Remove active class from all tabs and sections
      profileTabs.forEach(t => t.classList.remove('active'));
      profileSections.forEach(s => s.classList.remove('active'));
      
      // Add active class to clicked tab and corresponding section
      this.classList.add('active');
      document.getElementById(`${tabName}-section`).classList.add('active');
      
      // Load content for the tab if needed
      if (tabName === 'my-list') {
        loadUserMyList();
      } else if (tabName === 'messages') {
        loadUserMessages();
        checkUserMessageLimit(); // Check message limit when viewing messages tab
      }
    });
  });
  
  // Admin tabs
  adminTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.dataset.tab;
      
      // Remove active class from all tabs
      adminTabs.forEach(t => t.classList.remove('active'));
      
      // Add active class to clicked tab
      this.classList.add('active');
      
      // Show corresponding section
      if (tabName === 'users') {
        document.getElementById('users-section').style.display = 'block';
        document.getElementById('messages-section').style.display = 'none';
        loadUsers();
      } else if (tabName === 'messages') {
        document.getElementById('users-section').style.display = 'none';
        document.getElementById('messages-section').style.display = 'block';
        loadMessageRecipients();
        loadAdminMessages(); // NEW: Load messages for admin
      }
    });
  });
  
  // Admin message form
  adminMessageForm.addEventListener('submit', handleSendAdminMessage);
  
  // User message form
  sendUserMessageBtn.addEventListener('click', handleSendUserMessage);
  
  // Modal event listeners
  closeEditModal.addEventListener('click', () => editUserModal.style.display = 'none');
  cancelEdit.addEventListener('click', () => editUserModal.style.display = 'none');
  saveEdit.addEventListener('click', handleSaveUserEdit);
  
  closeMessageModal.addEventListener('click', () => sendMessageModal.style.display = 'none');
  cancelMessage.addEventListener('click', () => sendMessageModal.style.display = 'none');
  sendMessage.addEventListener('click', handleSendIndividualMessage);
  
  closeDeleteModal.addEventListener('click', () => deleteConfirmationModal.style.display = 'none');
  cancelDelete.addEventListener('click', () => deleteConfirmationModal.style.display = 'none');
  confirmDelete.addEventListener('click', handleDeleteUser);
  
  // Delete message modal event listeners
  closeDeleteMessageModal.addEventListener('click', () => deleteMessageModal.style.display = 'none');
  cancelDeleteMessage.addEventListener('click', () => deleteMessageModal.style.display = 'none');
  confirmDeleteMessage.addEventListener('click', handleDeleteMessage);

  document.getElementById("google-login-btn").addEventListener("click", handleGoogleSignIn)
  document.getElementById("google-register-btn").addEventListener("click", handleGoogleSignIn)
}

// Toggle profile dropdown
function toggleProfileDropdown() {
  profileDropdown.classList.toggle('active');
}

// Handle logout
async function handleLogout() {
  try {
    // Limpiar todos los listeners de mensajes
    Object.values(messageListeners).forEach(unsubscribe => {
      if (typeof unsubscribe === 'function') {
        unsubscribe();
      }
    });
    messageListeners = {};
    
    // Sign out from Firebase Auth
    await signOut(auth);
    
    // Clear current user
    currentUser = null;
    isAdmin = false;
    
    // Show auth container and hide app
    authContainer.style.display = 'flex';
    userProfilePage.classList.remove('active');
    adminPanel.classList.remove('active');
    
    // Reset forms
    loginForm.reset();
    registerForm.reset();
    loginError.style.display = 'none';
    registerError.style.display = 'none';
    registerSuccess.style.display = 'none';
    
    // Show login form
    loginFormContainer.style.display = 'block';
    registerFormContainer.style.display = 'none';
  } catch (error) {
    console.error("Error signing out:", error);
  }
}

// Show user profile
function showUserProfile() {
  // Hide all views
  homeView.classList.remove('active');
  moviesView.classList.remove('active');
  seriesView.classList.remove('active');
  animesView.classList.remove('active');
  doramasView.classList.remove('active');
  genreResultsView.classList.remove('active');
  searchResultsView.classList.remove('active');
  adminPanel.classList.remove('active');
  
  // Show profile page
  userProfilePage.classList.add('active');
  
  // Update profile information
  profileAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
  profileName.textContent = currentUser.name;
  profileEmail.textContent = currentUser.email;
  infoName.textContent = currentUser.name;
  infoEmail.textContent = currentUser.email;
  
  // Format date
  const registeredDate = currentUser.registeredAt instanceof Date 
    ? currentUser.registeredAt 
    : currentUser.registeredAt?.toDate?.() || new Date();
  infoDate.textContent = registeredDate.toLocaleDateString();
  
  // Reset tabs
  profileTabs.forEach(tab => tab.classList.remove('active'));
  profileSections.forEach(section => section.classList.remove('active'));
  profileTabs[0].classList.add('active');
  profileSections[0].classList.add('active');
  
  // Load user's my list
  loadUserMyList();
  
  // Load user's messages
  loadUserMessages();
  
  // Check user message limit
  checkUserMessageLimit();
}

// Load user's my list
async function loadUserMyList() {
  if (!currentUser) return;
  
  try {
    // Get user document from Firestore
    const userDoc = await getDoc(doc(db, "users", currentUser.id));
    
    if (userDoc.exists() && userDoc.data().myList && userDoc.data().myList.length > 0) {
      renderGridView(profileMyListGrid, userDoc.data().myList);
    } else {
      profileMyListGrid.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-film empty-icon"></i>
          <h3 class="empty-title">No hay contenido en tu lista</h3>
          <p class="empty-text">Agrega contenido a tu lista para verlo aqu√≠.</p>
        </div>
      `;
    }
  } catch (error) {
    console.error("Error loading user's my list:", error);
    profileMyListGrid.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-circle empty-icon"></i>
        <h3 class="empty-title">Error al cargar la lista</h3>
        <p class="empty-text">Ha ocurrido un error al cargar tu lista. Por favor, intenta de nuevo m√°s tarde.</p>
        </div>
      `;
  }
}

// Load user's messages with real-time updates
function loadUserMessages() {
  if (!currentUser) return;
  
  try {
    // Limpiar listener anterior si existe
    if (messageListeners[currentUser.id]) {
      messageListeners[currentUser.id]();
    }
    
    // Mostrar estado de carga
    messagesList.innerHTML = `
      <div class="message-item" style="text-align: center;">
        <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
        <p style="margin-top: 10px;">Cargando mensajes...</p>
      </div>
    `;
    noMessages.style.display = 'none';
    
    // Crear una consulta para escuchar mensajes en tiempo real
    const messagesQuery = query(
      collection(db, "messages"),
      where("to", "in", [currentUser.id, "all"]),
      orderBy("date", "desc")
    );
    
    // Configurar listener en tiempo real
    const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
      const userMessages = [];
      
      snapshot.forEach((doc) => {
        userMessages.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      if (userMessages.length > 0) {
        noMessages.style.display = 'none';
        messagesList.innerHTML = '';
        
        userMessages.forEach(message => {
          const messageDate = message.date instanceof Date 
            ? message.date 
            : message.date?.toDate?.() || new Date();
            
          const messageItem = document.createElement('div');
          messageItem.className = 'message-item';
          
          // Determinar si el usuario puede eliminar este mensaje
          const canDelete = message.from === currentUser.id || (isAdmin && message.to === currentUser.id);
          
          messageItem.innerHTML = `
            <div class="message-header">
              <span class="message-sender">${message.from === 'admin' ? 'Administrador' : message.from === currentUser.id ? 'Yo' : 'Sistema'}</span>
              <span class="message-date">${messageDate.toLocaleString()}</span>
            </div>
            <div class="message-content">${message.content}</div>
            ${canDelete ? `
              <div class="message-actions">
                <button class="message-delete-btn" data-id="${message.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            ` : ''}
          `;
          
          messagesList.appendChild(messageItem);
          
          // Agregar event listener al bot√≥n de eliminar si existe
          if (canDelete) {
            const deleteBtn = messageItem.querySelector('.message-delete-btn');
            deleteBtn.addEventListener('click', () => {
              showDeleteMessageModal(message.id);
            });
          }
        });
        
        // A√ëADIR AQU√ç: Contar mensajes no le√≠dos y actualizar el badge
        const unreadMessages = userMessages.filter(message => 
          message.from === 'admin' && !message.read
        );
        updateNotificationBadge(unreadMessages.length);
        
      } else {
        noMessages.style.display = 'block';
        messagesList.innerHTML = '';
        updateNotificationBadge(0); // A√ëADIR ESTA L√çNEA
      }
    }, (error) => {
      console.error("Error loading user's messages:", error);
      noMessages.style.display = 'none';
      messagesList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-circle empty-icon"></i>
          <h3 class="empty-title">Error al cargar los mensajes</h3>
          <p class="empty-text">Ha ocurrido un error al cargar tus mensajes. Por favor, intenta de nuevo m√°s tarde.</p>
        </div>
      `;
      updateNotificationBadge(0); // A√ëADIR ESTA L√çNEA
    });
    
    // Guardar referencia al listener para limpiarlo despu√©s
    messageListeners[currentUser.id] = unsubscribe;
    
  } catch (error) {
    console.error("Error setting up message listener:", error);
    noMessages.style.display = 'none';
    messagesList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-circle empty-icon"></i>
        <h3 class="empty-title">Error al cargar los mensajes</h3>
        <p class="empty-text">Ha ocurrido un error al cargar tus mensajes. Por favor, intenta de nuevo m√°s tarde.</p>
      </div>
    `;
    updateNotificationBadge(0); // A√ëADIR ESTA L√çNEA
  }
}

// A√±adir esta funci√≥n despu√©s de loadUserMessages
function updateNotificationBadge(count) {
  const profileIcon = document.getElementById('profile-icon');
  
  // Eliminar badge existente si hay alguno
  const existingBadge = profileIcon.querySelector('.notification-badge');
  if (existingBadge) {
    existingBadge.remove();
  }
  
  // A√±adir nuevo badge si hay mensajes no le√≠dos
  if (count > 0) {
    const badge = document.createElement('div');
    badge.className = 'notification-badge';
    badge.textContent = count > 9 ? '9+' : count;
    profileIcon.appendChild(badge);
  }
}

// A√±adir esta funci√≥n para marcar mensajes como le√≠dos
async function markMessagesAsRead() {
  if (!currentUser) return;
  
  try {
    // Obtener todos los mensajes no le√≠dos para el usuario
    const messagesQuery = query(
      collection(db, "messages"),
      where("to", "in", [currentUser.id, "all"]),
      where("read", "==", false)
    );
    
    const unreadSnapshot = await getDocs(messagesQuery);
    
    // Si no hay mensajes no le√≠dos, salir
    if (unreadSnapshot.empty) return;
    
    // Actualizar cada mensaje para marcarlo como le√≠do
    const batch = writeBatch(db);
    unreadSnapshot.forEach((doc) => {
      batch.update(doc.ref, { read: true });
    });
    
    await batch.commit();
    
    // Actualizar el badge de notificaci√≥n
    updateNotificationBadge(0);
    
  } catch (error) {
    console.error("Error marking messages as read:", error);
  }
}

// Check user message limit
async function checkUserMessageLimit() {
  if (!currentUser || isAdmin) {
    // Los administradores no tienen l√≠mite de mensajes
    sendUserMessageBtn.disabled = false;
    messageLimitInfo.textContent = 'Puedes enviar mensajes al administrador.';
    messageLimitInfo.className = 'message-limit-info';
    return;
  }
  
  try {
    // Obtener el documento del usuario para verificar los mensajes enviados
    const userDoc = await getDoc(doc(db, "users", currentUser.id));
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      const messagesSent = userData.messagesSent || [];
      
      // Obtener la fecha actual (solo a√±o, mes, d√≠a)
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Filtrar mensajes enviados hoy
      const messagesToday = messagesSent.filter(msg => {
        const msgDate = msg.date instanceof Date 
          ? msg.date 
          : msg.date?.toDate?.() || new Date();
        
        const msgDateOnly = new Date(msgDate);
        msgDateOnly.setHours(0, 0, 0, 0);
        
        return msgDateOnly.getTime() === today.getTime();
      });
      
      // Verificar si el usuario ha alcanzado el l√≠mite diario
      if (messagesToday.length >= 2) {
        sendUserMessageBtn.disabled = true;
        messageLimitInfo.textContent = 'Has alcanzado el l√≠mite de 2 mensajes por d√≠a. Intenta de nuevo ma√±ana.';
        messageLimitInfo.className = 'message-limit-info message-limit-warning';
      } else {
        sendUserMessageBtn.disabled = false;
        messageLimitInfo.textContent = `Puedes enviar ${2 - messagesToday.length} mensaje${messagesToday.length === 1 ? '' : 's'} m√°s hoy.`;
        messageLimitInfo.className = 'message-limit-info';
      }
    }
  } catch (error) {
    console.error("Error checking message limit:", error);
    sendUserMessageBtn.disabled = false;
    messageLimitInfo.textContent = 'Error al verificar l√≠mite de mensajes. Puedes intentar enviar un mensaje.';
    messageLimitInfo.className = 'message-limit-info';
  }
}

// Handle send user message
async function handleSendUserMessage() {
  if (!currentUser) return;
  
  const content = userMessageContent.value.trim();
  
  // Validate form
  if (!content) {
    alert('Por favor, escribe un mensaje');
    return;
  }
  
  try {
    // Mostrar indicador de carga
    sendUserMessageBtn.textContent = 'Enviando...';
    sendUserMessageBtn.disabled = true;
    
    // Obtener la fecha actual
    const now = new Date();
    
    // Agregar mensaje a Firestore
    const messageRef = await addDoc(collection(db, "messages"), {
      from: currentUser.id,
      to: 'admin',
      content: content,
      date: serverTimestamp(),
      read: false,
      userName: currentUser.name // Incluir el nombre del usuario para facilitar la identificaci√≥n
    });
    
    // Actualizar el registro de mensajes enviados por el usuario
    const userRef = doc(db, "users", currentUser.id);
    const userDoc = await getDoc(userRef);
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      const messagesSent = userData.messagesSent || [];
      
      // Agregar el nuevo mensaje al registro
      messagesSent.push({
        id: messageRef.id,
        date: now
      });
      
      // Actualizar el documento del usuario
      await updateDoc(userRef, {
        messagesSent: messagesSent
      });
    }
    
    // Limpiar el formulario
    userMessageContent.value = '';
    
    // Restaurar bot√≥n
    sendUserMessageBtn.textContent = 'Enviar mensaje';
    
    // Verificar l√≠mite de mensajes
    checkUserMessageLimit();
    
    // Mostrar mensaje de √©xito
  } catch (error) {
    console.error("Error sending user message:", error);
    alert("Error al enviar el mensaje. Por favor, intenta de nuevo m√°s tarde.");
    
    // Restaurar bot√≥n
    sendUserMessageBtn.textContent = 'Enviar mensaje';
    sendUserMessageBtn.disabled = false;
  }
}

// Show delete message modal
function showDeleteMessageModal(messageId) {
  deleteMessageId.value = messageId;
  deleteMessageModal.style.display = 'block';
}

// Handle delete message
async function handleDeleteMessage() {
  const messageId = deleteMessageId.value;
  
  try {
    // Eliminar mensaje de Firestore
    await deleteDoc(doc(db, "messages", messageId));
    
    // Si el mensaje fue enviado por el usuario actual, actualizar su registro de mensajes enviados
    if (!isAdmin) {
      const userRef = doc(db, "users", currentUser.id);
      const userDoc = await getDoc(userRef);
      
      if (userDoc.exists()) {
        const userData = userDoc.data();
        let messagesSent = userData.messagesSent || [];
        
        // Filtrar el mensaje eliminado
        messagesSent = messagesSent.filter(msg => msg.id !== messageId);
        
        // Actualizar el documento del usuario
        await updateDoc(userRef, {
          messagesSent: messagesSent
        });
        
        // Verificar l√≠mite de mensajes
        checkUserMessageLimit();
      }
    }
    
    // Cerrar modal
    deleteMessageModal.style.display = 'none';
    
    // Mostrar mensaje de √©xito
    alert('Mensaje eliminado correctamente');
  } catch (error) {
    console.error("Error deleting message:", error);
    alert("Error al eliminar el mensaje. Por favor, intenta de nuevo m√°s tarde.");
  }
}

// Show admin panel
function showAdminPanel() {
  if (!isAdmin) return;
  
  // Hide all views
  homeView.classList.remove('active');
  moviesView.classList.remove('active');
  seriesView.classList.remove('active');
  animesView.classList.remove('active');
  doramasView.classList.remove('active');
  genreResultsView.classList.remove('active');
  searchResultsView.classList.remove('active');
  userProfilePage.classList.remove('active');
  
  // Show admin panel
  adminPanel.classList.add('active');
  
  // Reset tabs
  adminTabs.forEach(tab => tab.classList.remove('active'));
  adminTabs[0].classList.add('active');
  document.getElementById('users-section').style.display = 'block';
  document.getElementById('messages-section').style.display = 'none';
  
  // Load users
  loadUsers();
  
  // Load message recipients
  loadMessageRecipients();
}

// Load users for admin panel
async function loadUsers() {
  if (!isAdmin) return;
  
  try {
    // Get all users from Firestore
    const usersSnapshot = await getDocs(collection(db, "users"));
    const tbody = usersTable.querySelector('tbody');
    tbody.innerHTML = '';
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const registeredDate = userData.registeredAt instanceof Date 
        ? userData.registeredAt 
        : userData.registeredAt?.toDate?.() || new Date();
        
      const tr = document.createElement('tr');
      
      tr.innerHTML = `
        <td>${userData.name}</td>
        <td>${userData.email}</td>
        <td>${registeredDate.toLocaleDateString()}</td>
        <td>
          <button class="admin-action-btn edit" data-id="${doc.id}">Editar</button>
          <button class="admin-action-btn message" data-id="${doc.id}" data-name="${userData.name}">Mensaje</button>
          <button class="admin-action-btn delete" data-id="${doc.id}">Eliminar</button>
        </td>
      `;
      
      tbody.appendChild(tr);
    });
    
    // Add event listeners to action buttons
    const editButtons = tbody.querySelectorAll('.edit');
    const messageButtons = tbody.querySelectorAll('.message');
    const deleteButtons = tbody.querySelectorAll('.delete');
    
    editButtons.forEach(button => {
      button.addEventListener('click', () => {
        const userId = button.dataset.id;
        showEditUserModal(userId);
      });
    });
    
    messageButtons.forEach(button => {
      button.addEventListener('click', () => {
        const userId = button.dataset.id;
        const userName = button.dataset.name;
        showSendMessageModal(userId, userName);
      });
    });
    
    deleteButtons.forEach(button => {
      button.addEventListener('click', () => {
        const userId = button.dataset.id;
        showDeleteConfirmationModal(userId);
      });
    });
  } catch (error) {
    console.error("Error loading users:", error);
    usersTable.querySelector('tbody').innerHTML = `
      <tr>
        <td colspan="4" style="text-align: center;">Error al cargar los usuarios. Por favor, intenta de nuevo m√°s tarde.</td>
      </tr>
    `;
  }
}

// Load message recipients for admin panel
async function loadMessageRecipients() {
  if (!isAdmin) return;
  
  try {
    // Clear previous options
    while (messageRecipient.options.length > 1) {
      messageRecipient.remove(1);
    }
    
    // Get all users from Firestore
    const usersSnapshot = await getDocs(collection(db, "users"));
    
    // Add users as options
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const option = document.createElement('option');
      option.value = doc.id;
      option.textContent = userData.name;
      messageRecipient.appendChild(option);
    });
  } catch (error) {
    console.error("Error loading message recipients:", error);
  }
}

// Load admin messages with real-time updates (NEW)
function loadAdminMessages() {
  if (!isAdmin) return;
  
  try {
    // Limpiar listener anterior si existe
    if (messageListeners['admin']) {
      messageListeners['admin']();
    }
    
    // Mostrar estado de carga
    adminMessagesList.innerHTML = `
      <div class="message-item" style="text-align: center;">
        <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
        <p style="margin-top: 10px;">Cargando mensajes...</p>
      </div>
    `;
    adminNoMessages.style.display = 'none';
    
    // Crear una consulta para escuchar mensajes enviados al admin en tiempo real
    const messagesQuery = query(
      collection(db, "messages"),
      where("to", "==", "admin"),
      orderBy("date", "desc")
    );
    
    // Configurar listener en tiempo real
    const unsubscribe = onSnapshot(messagesQuery, async (snapshot) => {
      const adminMessages = [];
      
      // Obtener todos los mensajes
      for (const docSnapshot of snapshot.docs) {
        const messageData = docSnapshot.data();
        
        // Si el mensaje es de un usuario, obtener su nombre
        if (messageData.from !== 'admin') {
          try {
            const userDoc = await getDoc(doc(db, "users", messageData.from));
            const userName = userDoc.exists() ? userDoc.data().name : 'Usuario desconocido';
            
            adminMessages.push({
              id: docSnapshot.id,
              ...messageData,
              userName: messageData.userName || userName
            });
          } catch (error) {
            console.error("Error getting user data for message:", error);
            adminMessages.push({
              id: docSnapshot.id,
              ...messageData,
              userName: 'Usuario desconocido'
            });
          }
        } else {
          adminMessages.push({
            id: docSnapshot.id,
            ...messageData
          });
        }
      }
      
      if (adminMessages.length > 0) {
        adminNoMessages.style.display = 'none';
        adminMessagesList.innerHTML = '';
        
        adminMessages.forEach(message => {
          const messageDate = message.date instanceof Date 
            ? message.date 
            : message.date?.toDate?.() || new Date();
            
          const messageItem = document.createElement('div');
          messageItem.className = 'message-item';
          
          messageItem.innerHTML = `
            <div class="message-header">
              <span class="message-sender">De: ${message.userName || 'Usuario'}</span>
              <span class="message-date">${messageDate.toLocaleString()}</span>
            </div>
            <div class="message-content">${message.content}</div>
            <div class="message-actions">
              <button class="message-delete-btn" data-id="${message.id}">
                <i class="fas fa-trash"></i>
              </button>
              <button class="admin-action-btn message" data-id="${message.from}" data-name="${message.userName || 'Usuario'}" style="margin-left: 10px; background-color: var(--accent-color); color: white; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem;">
                <i class="fas fa-reply"></i> Responder
              </button>
            </div>
          `;
          
          adminMessagesList.appendChild(messageItem);
          
          // Agregar event listener al bot√≥n de eliminar
          const deleteBtn = messageItem.querySelector('.message-delete-btn');
          deleteBtn.addEventListener('click', () => {
            showDeleteMessageModal(message.id);
          });
          
          // Agregar event listener al bot√≥n de responder
          const replyBtn = messageItem.querySelector('.admin-action-btn.message');
          replyBtn.addEventListener('click', () => {
            showSendMessageModal(message.from, message.userName || 'Usuario');
          });
        });
      } else {
        adminNoMessages.style.display = 'block';
        adminMessagesList.innerHTML = '';
      }
    }, (error) => {
      console.error("Error loading admin messages:", error);
      adminNoMessages.style.display = 'none';
      adminMessagesList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-circle empty-icon"></i>
          <h3 class="empty-title">Error al cargar los mensajes</h3>
          <p class="empty-text">Ha ocurrido un error al cargar los mensajes. Por favor, intenta de nuevo m√°s tarde.</p>
        </div>
      `;
    });
    
    // Guardar referencia al listener para limpiarlo despu√©s
    messageListeners['admin'] = unsubscribe;
    
  } catch (error) {
    console.error("Error setting up admin message listener:", error);
    adminNoMessages.style.display = 'none';
    adminMessagesList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-circle empty-icon"></i>
          <h3 class="empty-title">Error al cargar los mensajes</h3>
          <p class="empty-text">Ha ocurrido un error al cargar los mensajes. Por favor, intenta de nuevo m√°s tarde.</p>
        </div>
      `;
  }
}

// Show edit user modal
async function showEditUserModal(userId) {
  try {
    // Get user data from Firestore
    const userDoc = await getDoc(doc(db, "users", userId));
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      
      editName.value = userData.name;
      editEmail.value = userData.email;
      editUserId.value = userId;
      
      editUserModal.style.display = 'block';
    }
  } catch (error) {
    console.error("Error getting user data for edit:", error);
    alert("Error al cargar los datos del usuario. Por favor, intenta de nuevo m√°s tarde.");
  }
}

// Handle save user edit
async function handleSaveUserEdit() {
  const userId = editUserId.value;
  const name = editName.value.trim();
  const email = editEmail.value.trim();
  
  // Validate form
  if (!name || !email) {
    alert('Por favor, completa todos los campos');
    return;
  }
  
  try {
    // Update user in Firestore
    await updateDoc(doc(db, "users", userId), {
      name: name,
      email: email
    });
    
    // Close modal
    editUserModal.style.display = 'none';
    
    // Reload users
    loadUsers();
    
    // Show success message
    alert('Usuario actualizado correctamente');
  } catch (error) {
    console.error("Error updating user:", error);
    alert("Error al actualizar el usuario. Por favor, intenta de nuevo m√°s tarde.");
  }
}

// Show send message modal
function showSendMessageModal(userId, userName) {
  messageTo.value = userName;
  messageUserId.value = userId;
  individualMessageContent.value = '';
  
  sendMessageModal.style.display = 'block';
}

// Handle send individual message
async function handleSendIndividualMessage() {
  const userId = messageUserId.value;
  const content = individualMessageContent.value.trim();
  
  // Validate form
  if (!content) {
    alert('Por favor, escribe un mensaje');
    return;
  }
  
  try {
    // Mostrar indicador de carga
    sendMessage.textContent = 'Enviando...';
    sendMessage.disabled = true;
    
    // Add message to Firestore
    await addDoc(collection(db, "messages"), {
      from: 'admin',
      to: userId,
      content: content,
      date: serverTimestamp(),
      read: false
    });
    
    // Close modal
    sendMessageModal.style.display = 'none';
    
    // Reset button state
    sendMessage.textContent = 'Enviar';
    sendMessage.disabled = false;
    
    // Show success message
    alert('Mensaje enviado correctamente');
  } catch (error) {
    console.error("Error sending message:", error);
    alert("Error al enviar el mensaje. Por favor, intenta de nuevo m√°s tarde.");
    
    // Reset button state
    sendMessage.textContent = 'Enviar';
    sendMessage.disabled = false;
  }
}

// Handle send admin message
async function handleSendAdminMessage(e) {
  e.preventDefault();
  
  const recipient = messageRecipient.value;
  const content = messageContent.value.trim();
  
  // Validate form
  if (!content) {
    alert('Por favor, escribe un mensaje');
    return;
  }
  
  try {
    // Mostrar indicador de carga
    const submitBtn = adminMessageForm.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Enviando...';
    submitBtn.disabled = true;
    
    // Add message to Firestore
    await addDoc(collection(db, "messages"), {
      from: 'admin',
      to: recipient,
      content: content,
      date: serverTimestamp(),
      read: false
    });
    
    // Reset form
    adminMessageForm.reset();
    
    // Restaurar bot√≥n
    submitBtn.textContent = 'Enviar Mensaje';
    submitBtn.disabled = false;
    
    // Show success message
    alert('Mensaje enviado correctamente');
  } catch (error) {
    console.error("Error sending message:", error);
    alert("Error al enviar el mensaje. Por favor, intenta de nuevo m√°s tarde.");
    
    // Restaurar bot√≥n
    const submitBtn = adminMessageForm.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Enviar Mensaje';
    submitBtn.disabled = false;
  }
}

// Show delete confirmation modal
function showDeleteConfirmationModal(userId) {
  deleteUserId.value = userId;
  deleteConfirmationModal.style.display = 'block';
}

// Handle delete user
async function handleDeleteUser() {
  const userId = deleteUserId.value;
  
  try {
    // Delete user from Firestore
    await deleteDoc(doc(db, "users", userId));
    
    // Close modal
    deleteConfirmationModal.style.display = 'none';
    
    // Reload users
    loadUsers();
    
    // Show success message
    alert('Usuario eliminado correctamente');
  } catch (error) {
    console.error("Error deleting user:", error);
    alert("Error al eliminar el usuario. Por favor, intenta de nuevo m√°s tarde.");
  }
}

// Reset services function
function resetServices() {
  // Reset all services
  serviceItems.forEach(item => item.classList.remove('active'));
  currentService = null;
  
  // Reload original content
  loadAllContent();
  
  // Ocultar el bot√≥n de volver
  servicesBackBtn.style.display = 'none';
}

// Navigate to a specific view
function navigateToView(view) {
  // Hide all views
  homeView.classList.remove('active');
  moviesView.classList.remove('active');
  seriesView.classList.remove('active');
  animesView.classList.remove('active');
  doramasView.classList.remove('active');
  genreResultsView.classList.remove('active');
  searchResultsView.classList.remove('active');
  userProfilePage.classList.remove('active');
  adminPanel.classList.remove('active');

  // Remove active class from all nav links
  navLinks.forEach(link => link.classList.remove('active'));

  // Show selected view
  switch (view) {
    case 'home':
      homeView.classList.add('active');
      document.querySelector('.nav-link[data-section="home"]').classList.add('active');
      break;
    case 'movies':
      // Shuffle movies content for a fresh experience
      moviesContent = shuffleArray([...moviesContent]);
      moviesView.classList.add('active');
      document.querySelector('.nav-link[data-section="movies"]').classList.add('active');
      renderGridView(moviesGrid, moviesContent);
      break;
    case 'series':
      // Shuffle series content for a fresh experience
      seriesContent = shuffleArray([...seriesContent]);
      seriesView.classList.add('active');
      document.querySelector('.nav-link[data-section="series"]').classList.add('active');
      renderGridView(seriesGrid, seriesContent);
      break;
    case 'animes':
      // Fetch and display anime content
      fetchAndDisplayAnimes();
      animesView.classList.add('active');
      document.querySelector('.nav-link[data-section="animes"]').classList.add('active');
      break;
    case 'doramas':
      // Fetch and display doramas content
      fetchAndDisplayDoramas();
      doramasView.classList.add('active');
      document.querySelector('.nav-link[data-section="doramas"]').classList.add('active');
      break;
    case 'genre-results':
      genreResultsView.classList.add('active');
      break;
    case 'search-results':
      searchResultsView.classList.add('active');
      break;
    default:
      homeView.classList.add('active');
      document.querySelector('.nav-link[data-section="home"]').classList.add('active');
      break;
  }

  currentView = view;
  scrollToTop();
}

function adjustSliders() {
  document.querySelectorAll('.slider-container').forEach(slider => {
    // Ajusta el ancho de las tarjetas seg√∫n el ancho de la ventana
    const containerWidth = slider.clientWidth;
    const cardWidth = containerWidth < 768 ? 140 : containerWidth < 992 ? 200 : 240;
    
    // Actualiza el estilo de las tarjetas
    slider.querySelectorAll('.content-card').forEach(card => {
      card.style.flexBasis = `${cardWidth - 16}px`; // 16px para m√°rgenes
    });
  });
}

// Load all content
async function loadAllContent() {
  try {
    // Generar y renderizar el hero slider (contenido cr√≠tico)
    const heroContent = await generateHeroContent();
    renderHeroSlides(heroContent);
    
    // Precarga las im√°genes cr√≠ticas (hero y primeras tarjetas)
    preloadCriticalImages(heroContent);
    
    // Carga el contenido visible inicialmente (above the fold)
    await loadInitialVisibleContent();
    
    // Carga el resto del contenido de forma diferida
    setTimeout(() => {
      loadDeferredContent();
    }, 1000);
    
    // Inicia el slideshow del hero
    startHeroSlideshow();
    
    // Oculta el spinner
    hideSpinner();
    
    // Comprueba el popup de bienvenida
    checkWelcomePopup();
    
  } catch (error) {
    console.error('Error loading content:', error);
    hideSpinner();
  }
}

// A√±ade estas nuevas funciones para carga progresiva
async function loadInitialVisibleContent() {
  try {
    // Obtiene una peque√±a muestra de pel√≠culas y series para mostrar inmediatamente
    const initialMovies = await fetchContentByIds(
      shuffleArray(contentIds.inicioMovieIds).slice(0, 10), 
      'movie'
    );
    
    const initialSeries = await fetchContentByIds(
      shuffleArray(contentIds.inicioSeriesIds).slice(0, 10), 
      'tv'
    );
    
    // Renderiza el contenido inicial (visible)
    trendingContent = shuffleArray([...initialMovies, ...initialSeries]).slice(0, 15);
    renderContentSlider(trendingSlider, trendingContent);
    
    // Renderiza pel√≠culas y series populares (parcialmente visible)
    moviesContent = initialMovies;
    seriesContent = initialSeries;
    renderContentSlider(moviesSlider, initialMovies.slice(0, 15));
    renderContentSlider(seriesSlider, initialSeries.slice(0, 15));
    
  } catch (error) {
    console.error('Error loading initial content:', error);
  }
}

async function loadDeferredContent() {
  try {
    // Carga contenido reci√©n agregado
    const recentlyAddedMovies = await fetchContentByIds(contentIds.recentlyAddedIds.movies, 'movie');
    const recentlyAddedSeries = await fetchContentByIds(contentIds.recentlyAddedIds.series, 'tv');
    const recentlyAddedContent = shuffleArray([...recentlyAddedMovies, ...recentlyAddedSeries]).slice(0, 15);
    
    // Renderiza contenido reci√©n agregado
    renderContentSlider(document.getElementById('recently-added-slider'), recentlyAddedContent);
    
    // Carga m√°s pel√≠culas y series para tener un cat√°logo m√°s completo
    const moreMovies = await fetchContentByIds(
      shuffleArray(contentIds.inicioMovieIds).slice(), 
      'movie'
    );
    
    const moreSeries = await fetchContentByIds(
      shuffleArray(contentIds.inicioSeriesIds).slice(), 
      'tv'
    );
    
    // Actualiza el contenido completo
    moviesContent = [...moviesContent, ...moreMovies];
    seriesContent = [...seriesContent, ...moreSeries];
    
  } catch (error) {
    console.error('Error loading deferred content:', error);
  }
}

// Funci√≥n para precargar im√°genes cr√≠ticas
function preloadCriticalImages(content) {
  if (!content || content.length === 0) return;
  
  // Limita el n√∫mero de im√°genes a precargar para no sobrecargar la red
  const imagesToPreload = content.slice(0, 3);
  
  imagesToPreload.forEach(item => {
    if (item.backdrop_path) {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = 'image';
      link.href = `${IMG_BASE_URL}/original${item.backdrop_path}`;
      document.head.appendChild(link);
    }
    
    if (item.poster_path) {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = 'image';
      link.href = `${IMG_BASE_URL}/w500${item.poster_path}`;
      document.head.appendChild(link);
    }
  });
}

// Render content in a slider
    function renderContentSlider(sliderElement, content) {
      sliderElement.innerHTML = '';

      if (content.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
          <i class="fas fa-film empty-icon"></i>
          <h3 class="empty-title">No hay contenido disponible</h3>
          <p class="empty-text">No se encontr√≥ contenido para mostrar en esta secci√≥n.</p>
        `;
        sliderElement.appendChild(emptyState);
        return;
      }

      content.forEach(item => {
        const card = document.createElement('div');
        card.className = 'content-card';
        card.dataset.id = item.id;
        card.dataset.type = item.media_type;

        const posterPath = item.poster_path 
          ? `${IMG_BASE_URL}/w500${item.poster_path}` 
          : 'https://via.placeholder.com/300x450?text=No+Image';

        const title = item.title || item.name || 'Sin t√≠tulo';
        const year = (item.release_date || item.first_air_date || '').split('-')[0] || 'N/A';
        const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
        const type = item.media_type === 'movie' ? 'Pel√≠cula' : 'Serie';

        card.innerHTML = `
          <img src="${posterPath}" alt="${title}" class="card-poster">
          <div class="card-rating">${rating}</div>
          <div class="card-badge">${type}</div>
          <div class="card-overlay">
            <h3 class="card-title">${title}</h3>
            <div class="card-info">
              <span>${year}</span>
              <span>${type}</span>
            </div>
            <div class="card-actions">
              <button class="card-btn play-btn" title="Ver ahora">
                <i class="fas fa-play"></i>
              </button>
              <button class="card-btn info-btn" title="M√°s informaci√≥n">
                <i class="fas fa-info"></i>
              </button>
              ${sliderElement.id === 'continue-watching-slider' ? `
                <button class="card-btn remove-btn" title="Eliminar de la lista">
                  <i class="fas fa-times"></i>
                </button>
              ` : ''}
            </div>
          </div>
        `;

        // Add event listeners 
        card.querySelector('.play-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          saveToContinuarViendo(item);
          window.open(`go:${item.id}`, '_blank');
        });

        card.querySelector('.info-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          showMovieDetailsModal(item.id, item.media_type);
        });

        if (sliderElement.id === 'continue-watching-slider') {
          card.querySelector('.remove-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            removeFromContinuarViendo(item.id);
            card.remove();
            
            // Check if continue watching is empty
            if (continueWatchingContent.length === 0) {
              continueWatchingSection.style.display = 'none';
            }
          });
        }

        card.addEventListener('click', () => {
          saveToContinuarViendo(item);
          window.open(`go:${item.id}`, '_blank');
        });

        sliderElement.appendChild(card);
      });
    }

function throttle(callback, delay = 100) {
  let lastCall = 0;
  
  return function(...args) {
    const now = new Date().getTime();
    if (now - lastCall < delay) return;
    
    lastCall = now;
    callback(...args);
  };
}

function debounce(callback, delay = 300) {
  let timer;
  
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => callback(...args), delay);
  };
}

// Render content in a grid view
function renderGridView(gridElement, content) {
  gridElement.innerHTML = '';

  if (content.length === 0) {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    emptyState.innerHTML = `
      <i class="fas fa-film empty-icon"></i>
      <h3 class="empty-title">No hay contenido disponible</h3>
      <p class="empty-text">No se encontr√≥ contenido para mostrar en esta secci√≥n.</p>
    `;
    gridElement.appendChild(emptyState);
    return;
  }

  content.forEach(item => {
    const card = document.createElement('div');
    card.className = 'grid-card';
    card.dataset.id = item.id;
    card.dataset.type = item.media_type;

    // Usar un placeholder mientras se carga la imagen real
    const posterPath = item.poster_path 
      ? `${IMG_BASE_URL}/w500${item.poster_path}` 
      : 'https://via.placeholder.com/300x450?text=No+Image';
    
    // Crear un placeholder SVG peque√±o
    const placeholderSvg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzIDQiPjxyZWN0IHdpZHRoPSIzIiBoZWlnaHQ9IjQiIGZpbGw9IiMzMzMiLz48L3N2Zz4=';

    const title = item.title || item.name || 'Sin t√≠tulo';
    const year = (item.release_date || item.first_air_date || '').split('-')[0] || 'N/A';
    const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
    const type = item.media_type === 'movie' ? 'Pel√≠cula' : 'Serie';

    card.innerHTML = `
      <img 
        src="${placeholderSvg}" 
        data-src="${posterPath}" 
        alt="${title}" 
        class="grid-poster lazy"
        loading="lazy"
      >
      <div class="grid-rating">${rating}</div>
      <div class="grid-badge">${type}</div>
      <div class="grid-info">
        <h3 class="grid-title">${title}</h3>
        <div class="grid-meta">
          <span>${year}</span>
          <span>${type}</span>
        </div>
      </div>
      <div class="grid-actions">
        <button class="grid-btn play-btn" title="Ver ahora">
          <i class="fas fa-play"></i>
        </button>
        <button class="grid-btn info-btn" title="M√°s informaci√≥n">
          <i class="fas fa-info"></i>
        </button>
        ${gridElement.id === 'profile-my-list-grid' ? `
          <button class="grid-btn remove-btn" title="Eliminar de la lista">
            <i class="fas fa-times"></i>
          </button>
        ` : ''}
      </div>
    `;

    // Mant√©n tus event listeners actuales
    card.querySelector('.play-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      saveToContinuarViendo(item);
      window.open(`go:${item.id}`, '_blank');
    });

    card.querySelector('.info-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      showMovieDetailsModal(item.id, item.media_type);
    });

    if (gridElement.id === 'profile-my-list-grid') {
      card.querySelector('.remove-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        removeFromMyList(item.id);
        card.remove();
      });
    }

    card.addEventListener('click', () => {
      saveToContinuarViendo(item);
      window.open(`go:${item.id}`, '_blank');
    });

    gridElement.appendChild(card);
  });
  
  // Inicializar lazy loading para las im√°genes reci√©n a√±adidas
  initLazyLoading();
}

// Render hero slides
    function renderHeroSlides(slides) {
      hero.innerHTML = '';
      
      slides.forEach((slide, index) => {
        const isActive = index === 0 ? 'active' : '';
        const slideElement = document.createElement('div');
        slideElement.className = `hero-slide ${isActive}`;
        slideElement.style.backgroundImage = `url('https://image.tmdb.org/t/p/original${slide.backdrop_path}')`;
        
        // Crear una descripci√≥n si no existe
        const description = slide.overview || 
                           (slide.media_type === 'movie' ? 
                            'Una pel√≠cula imperdible que te mantendr√° al borde de tu asiento.' : 
                            'Una serie fascinante con personajes inolvidables y una trama adictiva.');
        
        slideElement.innerHTML = `
          <div class="hero-overlay">
            <div class="hero-content">
              <h1 class="hero-title">${slide.title || slide.name}</h1>
              <p class="hero-description">${description.substring(0, 150)}${description.length > 150 ? '...' : ''}</p>
              <div class="hero-buttons">
                <button class="btn btn-primary hero-play-btn" data-id="${slide.id}" data-type="${slide.media_type}">
                  <i class="fas fa-play"></i> Ver ahora
                </button>
                <button class="btn btn-secondary">
                  <i class="fas fa-info-circle"></i> M√°s informaci√≥n
                </button>
              </div>
            </div>
          </div>
        `;
        
        hero.appendChild(slideElement);
      });
      
      // Add hero navigation dots
      const heroNav = document.createElement('div');
      heroNav.className = 'hero-nav';
      heroNav.id = 'hero-nav';
      
      slides.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = `hero-dot ${index === 0 ? 'active' : ''}`;
        dot.dataset.index = index;
        dot.addEventListener('click', () => goToHeroSlide(index));
        heroNav.appendChild(dot);
      });
      
      hero.appendChild(heroNav);
      
      // Add event listeners to play buttons
      document.querySelectorAll('.hero-play-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.dataset.id;
          const type = this.dataset.type;
          const slide = slides.find(s => s.id.toString() === id);
          
          if (slide) {
            saveToContinuarViendo(slide);
          }
          
          window.open(`go:${id}`, '_blank');
        });
      });

      // Add event listeners to info buttons
      document.querySelectorAll('.hero-buttons .btn-secondary').forEach((btn, index) => {
        btn.addEventListener('click', () => {
          const slide = slides[index];
          showMovieDetailsModal(slide.id, slide.media_type);
        });
      });
      
      // Update global variables
      heroSlides = document.querySelectorAll('.hero-slide');
      heroDots = document.querySelectorAll('.hero-dot');
    }

// Navigate slider
function navigateSlider(slider, direction) {
  const cardWidth = 240; // Ancho fijo de cada tarjeta
  const scrollAmount = cardWidth * 3; // Desplazar 3 tarjetas a la vez
  
  if (direction === 'prev') {
    slider.scrollBy({
      left: -scrollAmount,
      behavior: 'smooth'
    });
  } else {
    slider.scrollBy({
      left: scrollAmount,
      behavior: 'smooth'
    });
  }
}

// Start hero slideshow
function startHeroSlideshow() {
  clearInterval(heroInterval);
  heroInterval = setInterval(() => {
    goToHeroSlide((currentHeroSlide + 1) % heroSlides.length);
  }, 8000);
}

// Go to specific hero slide
function goToHeroSlide(index) {
  heroSlides[currentHeroSlide].classList.remove('active');
  heroDots[currentHeroSlide].classList.remove('active');
  
  currentHeroSlide = index;
  
  // Carga la imagen de fondo si es necesario
  if (heroSlides[currentHeroSlide].dataset.background) {
    heroSlides[currentHeroSlide].style.backgroundImage = heroSlides[currentHeroSlide].dataset.background;
    heroSlides[currentHeroSlide].removeAttribute('data-background');
  }
  
  heroSlides[currentHeroSlide].classList.add('active');
  heroDots[currentHeroSlide].classList.add('active');
  
  startHeroSlideshow();
}

// Toggle search
function toggleSearch() {
  searchInput.classList.toggle('active');
  if (searchInput.classList.contains('active')) {
    setTimeout(() => searchInput.focus(), 300);
  }
}

// Handle search
function handleSearch() {
  const query = searchInput.value.trim().toLowerCase();
  
  if (!query) {
    return;
  }
  
  // Determinar qu√© contenido buscar seg√∫n el contexto actual
  let contentToSearch = [];
  let searchTitle = '';
  
  // Si hay un servicio seleccionado, buscar solo en ese servicio
  if (currentService) {
    contentToSearch = [...trendingContent, ...moviesContent, ...seriesContent];
    searchTitle = `Resultados en ${currentService.charAt(0).toUpperCase() + currentService.slice(1)} para: "${query}"`;
  } 
  // Si no hay servicio, buscar seg√∫n la vista actual
  else {
    switch (currentView) {
      case 'movies':
        contentToSearch = moviesContent;
        searchTitle = `Resultados en Pel√≠culas para: "${query}"`;
        break;
      case 'series':
        contentToSearch = seriesContent;
        searchTitle = `Resultados en Series para: "${query}"`;
        break;
      case 'genre-results':
        // Ya estamos en resultados de g√©nero, usar ese contenido
        const genreContent = Array.from(genreResultsGrid.querySelectorAll('.grid-card')).map(card => {
          return {
            id: parseInt(card.dataset.id),
            media_type: card.dataset.type
          };
        });
        contentToSearch = genreContent;
        searchTitle = `Resultados en ${genreTitle.textContent} para: "${query}"`;
        break;
      default:
        // En home o cualquier otra vista, buscar en todo el contenido
        contentToSearch = [
          ...trendingContent,
          ...moviesContent,
          ...seriesContent
        ];
        searchTitle = `Resultados para: "${query}"`;
        break;
    }
  }
  
  // Eliminar duplicados por ID
  const uniqueContent = Array.from(
    new Map(contentToSearch.map(item => [item.id, item])).values()
  );
  
  // Filtrar contenido basado en la b√∫squeda
  const searchResults = uniqueContent.filter(item => 
    (item.title || item.name || '').toLowerCase().includes(query) ||
    (item.original_title || item.original_name || '').toLowerCase().includes(query)
  );
    
    // Actualizar t√≠tulo de resultados
    searchResultsTitle.textContent = searchTitle;
    
    // Renderizar resultados en vista de cuadr√≠cula
    renderGridView(searchResultsGrid, searchResults);
    
    // Navegar a la vista de resultados de b√∫squeda
  navigateToView('search-results');
  }

  // Toggle sidebar
  function toggleSidebar() {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
  }

  // Close sidebar
  function closeSidebarHandler() {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
  }

  // Handle genre click
  async function handleGenreClick(e) {
    const genreId = parseInt(e.currentTarget.dataset.genre);
    const genreName = e.currentTarget.textContent.trim();
    
    // Close sidebar
    closeSidebarHandler();
    
    // Show spinner
    showSpinner();
    
    try {
      // Obtener las pel√≠culas y series que ya tenemos cargadas
      const allMovies = await fetchContentByIds(contentIds.inicioMovieIds, 'movie');
      const allSeries = await fetchContentByIds(contentIds.inicioSeriesIds, 'tv');
      
      // Obtener los detalles completos para cada pel√≠cula
      const moviesWithGenres = await Promise.all(
        allMovies.map(async (movie) => {
          try {
            const response = await fetch(`${API_BASE_URL}/movie/${movie.id}?api_key=${API_KEY}&language=es-MX`);
            const data = await response.json();
            return {
              ...movie,
              genres: data.genres || []
            };
          } catch (error) {
            console.error(`Error fetching genres for movie ${movie.id}:`, error);
            return {
              ...movie,
              genres: []
            };
          }
        })
      );
      
      // Obtener los detalles completos para cada serie
      const seriesWithGenres = await Promise.all(
        allSeries.map(async (serie) => {
          try {
            const response = await fetch(`${API_BASE_URL}/tv/${serie.id}?api_key=${API_KEY}&language=es-MX`);
            const data = await response.json();
            return {
              ...serie,
              genres: data.genres || []
            };
          } catch (error) {
            console.error(`Error fetching genres for series ${serie.id}:`, error);
            return {
              ...serie,
              genres: []
            };
          }
        })
      );
      
      // Filtrar por g√©nero
      const filteredMovies = moviesWithGenres.filter(movie => 
        movie.genres && movie.genres.some(genre => genre.id === genreId)
      );
      
      const filteredSeries = seriesWithGenres.filter(serie => 
        serie.genres && serie.genres.some(genre => genre.id === genreId)
      );
      
      // Combinar resultados
      const genreResults = [...filteredMovies, ...filteredSeries];

      // Mezclar aleatoriamente los resultados
      const shuffledResults = genreResults.sort(() => Math.random() - 0.5);

      // Update genre title
      genreTitle.textContent = `G√©nero: ${genreName}`;

      // Render results in grid view
      renderGridView(genreResultsGrid, shuffledResults);
      
      // Navigate to genre results view
      navigateToView('genre-results');
      
    } catch (error) {
      console.error('Error fetching genre content:', error);
      // En caso de error, mostrar mensaje de no hay contenido
      genreTitle.textContent = `G√©nero: ${genreName}`;
      renderGridView(genreResultsGrid, []);
      navigateToView('genre-results');
    } finally {
      // Hide spinner
      hideSpinner();
    }
  }

  // Handle service click
  async function handleServiceClick(e) {
    const service = e.currentTarget.dataset.service;
    
    // Reset all services
    serviceItems.forEach(item => item.classList.remove('active'));
    
    // If clicking the same service, reset
    if (currentService === service) {
      currentService = null;
      loadAllContent();
      // Ocultar el bot√≥n de volver
      servicesBackBtn.style.display = 'none';
      return;
    }
    
    // Set active service
    e.currentTarget.classList.add('active');
    currentService = service;
    
    // Show spinner
    showSpinner();
    
    try {
      let movieIds = [];
      let seriesIds = [];
      
      // Get IDs based on selected service
      switch (service) {
        case 'netflix':
          movieIds = contentIds.netflixMovieIds;
          seriesIds = contentIds.netflixSeriesIds;
          break;
        case 'disney':
          movieIds = contentIds.disneyMovieIds;
          seriesIds = contentIds.disneySeriesIds;
          break;
        case 'hbo':
          movieIds = contentIds.hboMovieIds;
          seriesIds = contentIds.hboSeriesIds;
          break;
        case 'prime':
          movieIds = contentIds.primeMovieIds;
          seriesIds = contentIds.primeSeriesIds;
          break;
        case 'paramount':
          movieIds = contentIds.paramountMovieIds;
          seriesIds = contentIds.paramountSeriesIds;
          break;
      }
      
      // Fetch content for the selected service
      const movies = await fetchContentByIds(shuffleArray(movieIds), 'movie');
      const series = await fetchContentByIds(shuffleArray(seriesIds), 'tv');
      
      // Update content
      trendingContent = shuffleArray([...movies, ...series]).slice(0, 15);
      moviesContent = movies;
      seriesContent = series;

      // Render updated content
      renderContentSlider(trendingSlider, trendingContent);
      renderContentSlider(moviesSlider, moviesContent.slice(0, 15));
      renderContentSlider(seriesSlider, seriesContent.slice(0, 15));
      
      // Show back button in mobile view
      servicesBackBtn.style.display = 'flex';
      
    } catch (error) {
      console.error('Error fetching service content:', error);
    } finally {
      // Hide spinner
      hideSpinner();
    }
  }

  // Toggle back to top button
  function toggleBackToTop() {
    if (window.scrollY > 300) {
      backToTopBtn.classList.add('visible');
    } else {
      backToTopBtn.classList.remove('visible');
    }
  }

  // Scroll to top
  function scrollToTop() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }

  // Check welcome popup
  function checkWelcomePopup() {
    const dontShowAgain = localStorage.getItem('dontShowPopupAgain');
    
    if (dontShowAgain !== 'true') {
      welcomePopup.style.display = 'flex';
    }
  }

  // Handle close popup
  function handleClosePopup() {
    welcomePopup.style.display = 'none';
    
    if (dontShowAgain.checked) {
      localStorage.setItem('dontShowPopupAgain', 'true');
    }
  }

  // Load continue watching content
  async function loadContinuarViendo() {
    if (!currentUser) return [];
    
    try {
      // Get user document from Firestore
      const userDoc = await getDoc(doc(db, "users", currentUser.id));
      
      if (userDoc.exists() && userDoc.data().myList) {
        return userDoc.data().myList;
      }
      
      return [];
    } catch (error) {
      console.error("Error loading continue watching:", error);
      return [];
    }
  }

  // Save to continue watching
  async function saveToContinuarViendo(item) {
    if (!currentUser) return;
    
    try {
      // Get user document from Firestore
      const userDoc = await getDoc(doc(db, "users", currentUser.id));
      
      if (userDoc.exists()) {
        const userData = userDoc.data();
        let myList = userData.myList || [];
        
        // Check if item already exists
        const existingIndex = myList.findIndex(content => content.id === item.id);
        
        if (existingIndex !== -1) {
          // Update last visited date
          myList[existingIndex].lastVisited = new Date().toISOString();
        } else {
          // Add new item
          myList.push({
            ...item,
            lastVisited: new Date().toISOString()
          });
        }
        
        // Update user document in Firestore
        await updateDoc(doc(db, "users", currentUser.id), {
          myList: myList
        });
      }
    } catch (error) {
      console.error("Error saving to continue watching:", error);
    }
  }

// Remove from my list
async function removeFromMyList(itemId) {
  if (!currentUser) return;
  
  try {
    // Get user document from Firestore
    const userDoc = await getDoc(doc(db, "users", currentUser.id));
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      let myList = userData.myList || [];
      
      // Filter out the item to remove
      myList = myList.filter(item => item.id !== itemId);
      
      // Update user document in Firestore
      await updateDoc(doc(db, "users", currentUser.id), {
        myList: myList
      });
     
    }
  } catch (error) {
    console.error("Error removing from my list:", error);
    alert('Error al eliminar el elemento de tu lista');
  }
}
  // Show spinner
  function showSpinner() {
    spinnerContainer.style.display = 'flex';
  }

  // Hide spinner
  function hideSpinner() {
    spinnerContainer.style.display = 'none';
  }

  // Fetch content by IDs
async function fetchContentByIds(ids, type) {
  if (!ids || ids.length === 0) return [];
  
  try {
    const promises = ids.map(id => {
      const cacheKey = `${type}_${id}`;
      
      // Comprobar si est√° en cach√© y no ha expirado (30 minutos)
      if (apiCache.has(cacheKey)) {
        const cachedData = apiCache.get(cacheKey);
        const now = new Date().getTime();
        
        // Si la cach√© no ha expirado (30 minutos), devuelve los datos en cach√©
        if (now - cachedData.timestamp < 30 * 60 * 1000) {
          return cachedData.data;
        }
      }
      
      // Si no est√° en cach√© o ha expirado, realiza la solicitud
      return fetch(`${API_BASE_URL}/${type}/${id}?api_key=${API_KEY}&language=es-MX`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error fetching ${type} ${id}`);
          }
          return response.json();
        })
        .then(data => {
          // Almacena en cach√© con timestamp
          apiCache.set(cacheKey, {
            data: {
              ...data,
              media_type: type
            },
            timestamp: new Date().getTime()
          });
          
          return {
            ...data,
            media_type: type
          };
        })
        .catch(error => {
          console.error(error);
          return null;
        });
    });
    
    const results = await Promise.all(promises);
    return results.filter(item => item !== null);
  } catch (error) {
    console.error(`Error fetching ${type} content:`, error);
    return [];
  }
}

  // Generate hero content
    async function generateHeroContent() {
      try {
        // Obtener 2 pel√≠culas destacadas (las que especificaste)
        const featuredMovies = await fetchContentByIds(featuredMovieIds, 'movie');
        
        // Obtener 2 series destacadas (las que especificaste)
        const featuredSeries = await fetchContentByIds(featuredSeriesIds, 'tv');
        
        // Obtener 2 pel√≠culas aleatorias (excluyendo las destacadas)
        const randomMovieIds = shuffleArray([...contentIds.inicioMovieIds])
          .filter(id => !featuredMovieIds.includes(id))
          .slice(0, 2);
        const randomMovies = await fetchContentByIds(randomMovieIds, 'movie');
        
        // Obtener 2 series aleatorias (excluyendo las destacadas)
        const randomSeriesIds = shuffleArray([...contentIds.inicioSeriesIds])
          .filter(id => !featuredSeriesIds.includes(id))
          .slice(0, 2);
        const randomSeries = await fetchContentByIds(randomSeriesIds, 'tv');
        
        // Combinar y mezclar todo el contenido
        const heroContent = shuffleArray([
          ...featuredMovies,
          ...featuredSeries,
          ...randomMovies,
          ...randomSeries
        ]);
        
        return heroContent;
      } catch (error) {
        console.error('Error generando contenido para el hero:', error);
        return [];
      }
    }

  // Fetch and display animes
  async function fetchAndDisplayAnimes() {
    try {
      // Show spinner
      showSpinner();
      
      // Fetch anime content
      const animeMovies = await fetchContentByIds(contentIds.animesMovieIds, 'movie');
      const animeSeries = await fetchContentByIds(contentIds.animesSeriesIds, 'tv');
      
      // Combine and shuffle
      const animeContent = shuffleArray([...animeMovies, ...animeSeries]);
      
      // Render in grid view
      renderGridView(animesGrid, animeContent);
    } catch (error) {
      console.error('Error fetching anime content:', error);
      renderGridView(animesGrid, []);
    } finally {
      // Hide spinner
      hideSpinner();
    }
  }

  // Fetch and display doramas
  async function fetchAndDisplayDoramas() {
    try {
      // Show spinner
      showSpinner();
      
      // Fetch dorama content
      const doramaMovies = await fetchContentByIds(contentIds.doramasMovieIds, 'movie');
      const doramaSeries = await fetchContentByIds(contentIds.doramasSeriesIds, 'tv');
      
      // Combine and shuffle
      const doramaContent = shuffleArray([...doramaMovies, ...doramaSeries]);
      
      // Render in grid view
      renderGridView(doramasGrid, doramaContent);
    } catch (error) {
      console.error('Error fetching dorama content:', error);
      renderGridView(doramasGrid, []);
    } finally {
      // Hide spinner
      hideSpinner();
    }
  }

  // Show movie details modal
  async function showMovieDetailsModal(id, type) {
    // Create modal container if it doesn't exist
    const modalContainer = document.getElementById('movie-details-modal-container');
    
    // Show loading state
    modalContainer.innerHTML = `
      <div class="movie-details-modal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
          <button class="modal-close" id="close-details-modal">
            <i class="fas fa-times"></i>
          </button>
          <div class="modal-content">
            <div class="modal-loading">
              <div class="spinner"></div>
              <p>Cargando detalles...</p>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Add event listener to close button
    document.getElementById('close-details-modal').addEventListener('click', () => {
      modalContainer.innerHTML = '';
    });
    
    try {
      // Fetch movie/series details
      const response = await fetch(`${API_BASE_URL}/${type}/${id}?api_key=${API_KEY}&language=es-MX&append_to_response=credits,videos`);
      
      if (!response.ok) {
        throw new Error(`Error fetching ${type} details`);
      }
      
      const data = await response.json();
      
      // Format data
      const title = data.title || data.name || 'Sin t√≠tulo';
      const originalTitle = data.original_title || data.original_name || '';
      const year = (data.release_date || data.first_air_date || '').split('-')[0] || 'N/A';
      const runtime = data.runtime 
        ? `${Math.floor(data.runtime / 60)}h ${data.runtime % 60}m` 
        : data.episode_run_time && data.episode_run_time.length > 0 
          ? `${Math.floor(data.episode_run_time[0] / 60)}h ${data.episode_run_time[0] % 60}m` 
          : 'N/A';
      const rating = data.vote_average ? data.vote_average.toFixed(1) : 'N/A';
      const overview = data.overview || 'No hay descripci√≥n disponible.';
      const posterPath = data.poster_path 
        ? `${IMG_BASE_URL}/w500${data.poster_path}` 
        : 'https://via.placeholder.com/300x450?text=No+Image';
      const backdropPath = data.backdrop_path 
        ? `${IMG_BASE_URL}/original${data.backdrop_path}` 
        : null;
      
      // Get director or creator
      let director = 'N/A';
      if (type === 'movie' && data.credits && data.credits.crew) {
        const directorPerson = data.credits.crew.find(person => person.job === 'Director');
        director = directorPerson ? directorPerson.name : 'N/A';
      } else if (type === 'tv' && data.created_by && data.created_by.length > 0) {
        director = data.created_by.map(person => person.name).join(', ');
      }
      
      // Get cast
      const cast = data.credits && data.credits.cast 
        ? data.credits.cast.slice(0, 5).map(person => person.name).join(', ') 
        : 'N/A';
      
      // Get trailer
      let trailerKey = null;
      if (data.videos && data.videos.results && data.videos.results.length > 0) {
        const trailer = data.videos.results.find(video => 
          video.type === 'Trailer' && video.site === 'YouTube'
        ) || data.videos.results[0];
        
        trailerKey = trailer ? trailer.key : null;
      }
      
      // Render modal content
      const modalContent = `
        <div class="movie-details-modal">
          <div class="modal-overlay"></div>
          <div class="modal-container">
            ${backdropPath ? `
              <div class="modal-backdrop" style="background-image: url('${backdropPath}')">
                <div class="modal-backdrop-overlay"></div>
              </div>
            ` : ''}
            <button class="modal-close" id="close-details-modal">
              <i class="fas fa-times"></i>
            </button>
            <div class="modal-content">
              <div class="modal-header">
                <div class="modal-poster">
                  <img src="${posterPath}" alt="${title}">
                </div>
                <div class="modal-info">
                  <h2 class="modal-title">${title}</h2>
                  ${originalTitle && originalTitle !== title ? `<p class="modal-original-title">${originalTitle}</p>` : ''}
                  <div class="modal-meta">
                    <span>${year}</span>
                    <span>${runtime}</span>
                    <span class="modal-rating"><i class="fas fa-star"></i> ${rating}</span>
                  </div>
                  <div class="modal-genres">
                    ${data.genres && data.genres.map(genre => 
                      `<span class="modal-genre">${genre.name}</span>`
                    ).join('')}
                  </div>
                  <p class="modal-overview">${overview}</p>
                  <div class="modal-details">
                    <div class="modal-detail">
                      <span class="detail-label">${type === 'movie' ? 'Director' : 'Creador'}:</span>
                      <span class="detail-value">${director}</span>
                    </div>
                    <div class="modal-detail">
                      <span class="detail-label">Reparto:</span>
                      <span class="detail-value">${cast}</span>
                    </div>
                    ${type === 'tv' && data.number_of_seasons ? `
                      <div class="modal-detail">
                        <span class="detail-label">Temporadas:</span>
                        <span class="detail-value">${data.number_of_seasons}</span>
                        <div class="seasons-list">
                          ${Array.from({length: Math.min(data.number_of_seasons, 5)}, (_, i) => i + 1).map(season => `
                            <div class="season-item">
                              <span>Temporada ${season}</span>
                              <span class="episode-count">${
                                data.seasons && data.seasons[season] 
                                  ? `${data.seasons[season].episode_count} episodios` 
                                  : 'N/A'
                              }</span>
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                  <div class="modal-actions">
                    <button class="btn btn-primary watch-btn" data-id="${id}">
                      <i class="fas fa-play"></i> Ver ahora
                    </button>
                    ${trailerKey ? `
                      <button class="btn btn-secondary trailer-btn" data-key="${trailerKey}">
                        <i class="fas fa-film"></i> Ver trailer
                      </button>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Update modal container
      modalContainer.innerHTML = modalContent;
      
      // Add event listeners
      document.getElementById('close-details-modal').addEventListener('click', () => {
        modalContainer.innerHTML = '';
      });
      
      document.querySelector('.watch-btn').addEventListener('click', () => {
        saveToContinuarViendo({
          id: data.id,
          media_type: type,
          title: data.title || data.name,
          poster_path: data.poster_path,
          release_date: data.release_date || data.first_air_date,
          vote_average: data.vote_average
        });
        window.open(`go:${id}`, '_blank');
      });
      
if (trailerKey) {
  document.querySelector('.trailer-btn').addEventListener('click', () => {
    // Crear el modal para el trailer
    const trailerModalContainer = document.getElementById('trailer-modal-container');
    trailerModalContainer.innerHTML = `
      <div class="movie-details-modal">
        <div class="modal-overlay"></div>
        <div class="modal-container" style="max-width: 800px;">
          <button class="modal-close" id="close-trailer-modal">
            <i class="fas fa-times"></i>
          </button>
          <div class="modal-content" style="padding: 0;">
            <iframe 
              width="100%" 
              height="450" 
              src="https://www.youtube.com/embed/${trailerKey}?autoplay=1" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen
              style="border-radius: var(--border-radius);"
            ></iframe>
          </div>
        </div>
      </div>
    `;
    
    // A√±adir event listener para cerrar el modal
    document.getElementById('close-trailer-modal').addEventListener('click', () => {
      trailerModalContainer.innerHTML = '';
    });
    
    // Tambi√©n cerrar al hacer clic en el overlay
    trailerModalContainer.querySelector('.modal-overlay').addEventListener('click', () => {
      trailerModalContainer.innerHTML = '';
    });
  });
}
    } catch (error) {
      console.error('Error fetching movie details:', error);
      
      // Show error state
      modalContainer.innerHTML = `
        <div class="movie-details-modal">
          <div class="modal-overlay"></div>
          <div class="modal-container">
            <button class="modal-close" id="close-details-modal">
              <i class="fas fa-times"></i>
            </button>
            <div class="modal-content">
              <div class="modal-error">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Error al cargar los detalles</h3>
                <p>No se pudieron cargar los detalles de este contenido. Por favor, intenta de nuevo m√°s tarde.</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add event listener to close button 
      document.getElementById('close-details-modal').addEventListener('click', () => {
        modalContainer.innerHTML = '';
      });
    }
  }

  // Utility function to shuffle array
  function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
  }

// A√±ade esta funci√≥n al final de tu archivo JavaScript principal
function initLazyLoading() {
  // Comprueba si el navegador soporta Intersection Observer
  if ('IntersectionObserver' in window) {
    const lazyImageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const lazyImage = entry.target;
          
          // Reemplaza el src con el data-src
          if (lazyImage.dataset.src) {
            lazyImage.src = lazyImage.dataset.src;
            lazyImage.removeAttribute('data-src');
          }
          
          // A√±ade la clase loaded para efectos de transici√≥n
          lazyImage.classList.add('loaded');
          
          // Deja de observar la imagen una vez cargada
          observer.unobserve(lazyImage);
        }
      });
    }, {
      rootMargin: '200px 0px', // Carga im√°genes 200px antes de que entren en el viewport
      threshold: 0.01 // Trigger cuando al menos 1% de la imagen es visible
    });

    // Observa todas las im√°genes con atributo data-src
    document.querySelectorAll('img.lazy').forEach(img => {
      lazyImageObserver.observe(img);
    });
  } else {
    // Fallback para navegadores que no soportan Intersection Observer
    // Carga todas las im√°genes inmediatamente
    document.querySelectorAll('img.lazy').forEach(img => {
      if (img.dataset.src) {
        img.src = img.dataset.src;
        img.classList.add('loaded');
      }
    });
  }
}

// Inicializa lazy loading cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
  initLazyLoading();
});
</script>
</body>
</html>
